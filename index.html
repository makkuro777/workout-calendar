<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ç­‹ãƒˆãƒ¬ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: system-ui, sans-serif;
      background: #f7f7f7;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app {
      position: relative;
      width: 380px;
      max-width: 100%;
      height: 100%;
      background: #f7f7f7;
      overflow: hidden;
    }

    .container {
      height: 100%;
      padding: 8px;
      overflow: hidden;
    }

    /* --- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ --- */
    .top-bar {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }
    .menu-btn {
      font-size: 22px;
      background: transparent;
      border: none;
    }

    .side-menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      opacity: 0;
      pointer-events: none;
      transition: 0.2s;
      z-index: 30;
    }
    .side-menu-overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    .side-menu {
      position: fixed;
      top: 0;
      left: 0;
      width: 70%;
      max-width: 280px;
      height: 100%;
      background: #fff;
      transform: translateX(-100%);
      transition: 0.25s;
      padding: 16px;
      z-index: 40;
      box-shadow: 2px 0 10px rgba(0,0,0,0.3);
    }
    .side-menu.open {
      transform: translateX(0);
    }

    .side-menu-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .side-menu-item {
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      margin-bottom: 4px;
    }
    .side-menu-item.active {
      background: #e3f2fd;
      color: #1976d2;
      font-weight: bold;
    }

    /* --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ --- */
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
      margin-bottom: 5px;
    }

    .month-label {
      flex: 1;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
    }

    .calendar-wrapper {
      overflow: hidden;
      width: 100%;
    }

    th {
      font-size: 13px;
      padding: 4px 0;
    }
    td {
      height: 60px;
      border: 1px solid #ddd;
      vertical-align: top;
      padding: 4px;
    }

    .day-number {
      font-weight: bold;
      font-size: 12px;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .today {
      background: rgba(0,0,255,0.15);
      border-radius: 50%;
    }
    .selected-day {
      background: #fff9c4 !important;
    }

    /* ãƒãƒƒã‚¸ */
    .exercise-chip {
      display: inline-block;
      padding: 2px 6px;
      font-size: 10px;
      border-radius: 999px;
      color: #fff;
      margin: 1px 2px 0 0;
      white-space: nowrap;
    }

    /* --- ãƒ¡ãƒ¢æ¬„ï¼ˆã‚·ãƒ¼ãƒˆï¼‰ --- */
    .sheet {
      position: fixed;
      left: 50%;
      transform: translateX(-50%) translateY(calc(100% - 24px));
      width: 380px;
      max-width: 100%;
      background: #fff;
      border-radius: 16px 16px 0 0;
      padding: 12px;
      max-height: 75vh;
      overflow-y: auto;
      transition: 0.3s ease;
      z-index: 50;
    }
    .sheet.open {
      transform: translateX(-50%) translateY(0);
    }

    .sheet-handle {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-bottom: 6px;
      touch-action: pan-y;
    }
    .sheet-handle-bar {
      width: 40px;
      height: 12px;
      border-radius: 6px;
      background: #ccc;
    }

    .exercise-block {
      background: #fafafa;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 8px;
      margin-bottom: 10px;
    }

    .exercise-title {
      font-size: 13px;
      font-weight: bold;
    }

    .body-part-badge {
      padding: 2px 6px;
      font-size: 10px;
      background: #000;
      color: #fff;
      border-radius: 10px;
      margin-left: 4px;
    }

    .remove-exercise {
      color: #d32f2f;
      background: none;
      border: none;
      font-size: 12px;
    }

    .set-row {
      position: relative;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 6px 30px 6px 6px;
      margin-top: 6px;
    }

    .delete-set-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      font-size: 16px;
      color: #d32f2f;
      border: none;
      background: none;
    }

  </style>
</head>

<body>
<div class="app">

  <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®é»’èƒŒæ™¯ -->
  <div id="menu-overlay" class="side-menu-overlay"></div>

  <!-- å·¦ã‹ã‚‰å‡ºã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
  <div id="side-menu" class="side-menu">
    <div class="side-menu-header">
      <div class="side-menu-title">è¡¨ç¤ºåˆ‡æ›¿</div>
      <button id="menu-close" class="side-menu-close">â–²</button>
    </div>

    <div id="menu-month" class="side-menu-item active">æœˆè¡¨ç¤º</div>
    <div id="menu-week" class="side-menu-item">é€±è¡¨ç¤º</div>
  </div>


  <div class="container">

    <div class="top-bar">
      <button id="menu-btn" class="menu-btn">â˜°</button>
    </div>

    <!-- æœˆè¡¨ç¤ºã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
    <div id="month-view">
      <div class="calendar-header">
        <button id="prev" class="nav-btn">ï¼œ</button>
        <div id="month-label" class="month-label"></div>
        <select id="month-select"></select>
        <button id="next" class="nav-btn">ï¼</button>
      </div>

      <div class="calendar-wrapper">
        <table id="calendar-table">
          <thead>
            <tr>
              <th>æ—¥</th><th>æœˆ</th><th>ç«</th><th>æ°´</th>
              <th>æœ¨</th><th>é‡‘</th><th>åœŸ</th>
            </tr>
          </thead>
          <tbody id="calendar-body"></tbody>
        </table>
      </div>
    </div>


    <!-- é€±è¡¨ç¤º -->
    <div id="week-view" style="display:none;">
      <div class="calendar-header">
        <button id="week-prev" class="nav-btn">ï¼œ</button>
        <div id="week-label" class="month-label"></div>
        <button id="week-next" class="nav-btn">ï¼</button>
      </div>

      <div class="calendar-wrapper">
        <table id="week-table">
          <thead>
            <tr>
              <th>æ—¥</th><th>æœˆ</th><th>ç«</th><th>æ°´</th>
              <th>æœ¨</th><th>é‡‘</th><th>åœŸ</th>
            </tr>
          </thead>
          <tbody id="week-body"></tbody>
        </table>
      </div>
    </div>

  </div> <!-- /container -->

  <!-- ãƒ¡ãƒ¢ã‚·ãƒ¼ãƒˆ -->
  <div id="sheet" class="sheet">
    <div id="sheet-handle" class="sheet-handle">
      <div class="sheet-handle-bar"></div>
    </div>

    <div id="sheet-title" class="sheet-title"></div>

    <div id="exercise-list"></div>

    <button id="add-exercise" class="add-exercise-btn">ï¼‹ ç¨®ç›®ã‚’è¿½åŠ </button>

    <textarea id="note" placeholder="ãã®ä»–ãƒ¡ãƒ¢" style="width:100%; margin-top:10px;"></textarea>
  </div>

</div>
<script>
/* ------------------------------------------------------
   åŸºæœ¬è¨­å®š
------------------------------------------------------ */
let monthDate = new Date();
let weekDate = new Date();
let selectedDateKey = "";

const events = JSON.parse(localStorage.getItem("workout") || "{}");

const monthLabel = document.getElementById("month-label");
const calBody = document.getElementById("calendar-body");
const weekBody = document.getElementById("week-body");
const weekLabel = document.getElementById("week-label");

const sheet = document.getElementById("sheet");
const sheetTitle = document.getElementById("sheet-title");
const exerciseList = document.getElementById("exercise-list");
const note = document.getElementById("note");

/* éƒ¨ä½åˆ†é¡ */
const exerciseCategories = [
  { label: "èƒ¸", color: "#e91e63", items: ["ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹","ãƒ€ãƒ³ãƒ™ãƒ«ãƒ—ãƒ¬ã‚¹","ã‚¤ãƒ³ã‚¯ãƒ©ã‚¤ãƒ³ã‚¹ãƒŸã‚¹ãƒ—ãƒ¬ã‚¹","ãƒšãƒƒã‚¯ãƒ•ãƒ©ã‚¤"] },
  { label: "èƒŒä¸­", color: "#3f51b5", items: ["æ‡¸å‚","ãƒ©ãƒƒãƒˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³","ã‚·ãƒ¼ãƒ†ãƒƒãƒ‰ãƒ­ãƒ¼","ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ","ãƒ•ã‚§ã‚¤ã‚¹ãƒ—ãƒ«"] },
  { label: "è¶³", color: "#4caf50", items: ["ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ","ãƒ«ãƒ¼ãƒãƒ‹ã‚¢ãƒ³ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ","ãƒ–ãƒ«ã‚¬ãƒªã‚¢ãƒ³ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ","ãƒ’ãƒƒãƒ—ã‚¢ãƒ€ã‚¯ã‚·ãƒ§ãƒ³"] },
  { label: "è‚©", color: "#ff9800", items: ["ã‚·ãƒ§ãƒ«ãƒ€ãƒ¼ãƒ—ãƒ¬ã‚¹","ãƒªã‚¢ãƒ‡ãƒ«ãƒˆ","ã‚µã‚¤ãƒ‰ãƒ¬ã‚¤ã‚º"] },
  { label: "è…•", color: "#9c27b0", items: ["ã‚¤ãƒ³ã‚¯ãƒ©ã‚¤ãƒ³ãƒ€ãƒ³ãƒ™ãƒ«ã‚«ãƒ¼ãƒ«","ã‚±ãƒ¼ãƒ–ãƒ«ãƒ—ãƒ¬ã‚¹ãƒ€ã‚¦ãƒ³","ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³"] }
];

/* ------------------------------------------------------
   ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
------------------------------------------------------ */
function dateKey(y,m,d){
  return `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
}

function normalizeEvent(raw){
  if(!raw) return {exercises:[], note:""};
  return {
    exercises: raw.exercises || [],
    note: raw.note || ""
  };
}

function getBodyPart(exName) {
  for (const cat of exerciseCategories) {
    if (cat.items.includes(exName)) return cat.label;
  }
  return null;
}

/* â˜…â˜…â˜… ãƒã‚°ä¿®æ­£æ¸ˆã¿ï¼šc.color â†’ cat.color â˜…â˜…â˜… */
function getBodyPartColor(label) {
  const cat = exerciseCategories.find(c => c.label === label);
  return cat ? cat.color : "#999"; 
}

/* ------------------------------------------------------
   ãƒ¡ãƒ¢æ¬„ï¼ˆã‚·ãƒ¼ãƒˆï¼‰ã‚’é–‹ã
------------------------------------------------------ */
function openSheet(key){
  selectedDateKey = key;
  const data = normalizeEvent(events[key]);

  sheetTitle.textContent = `${key} ã®ç­‹ãƒˆãƒ¬`;
  exerciseList.innerHTML = "";

  if(data.exercises.length){
    data.exercises.forEach(ex => {
      exerciseList.appendChild(createExerciseBlock(ex));
    });
  } else {
    exerciseList.appendChild(createExerciseBlock({exercise:"",sets:[]})); 
  }
  note.value = data.note || "";

  sheet.classList.add("open");
}

/* ------------------------------------------------------
   æ—¥ä»˜ã‚¯ãƒªãƒƒã‚¯æ™‚
------------------------------------------------------ */
function handleDateClick(key){
  openSheet(key);
}

/* ------------------------------------------------------
   æœˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
------------------------------------------------------ */
function renderMonth(){
  const y = monthDate.getFullYear();
  const m = monthDate.getMonth();

  monthLabel.textContent = `${y}å¹´ ${m+1}æœˆ`;
  calBody.innerHTML = "";

  const first = new Date(y,m,1);
  const last  = new Date(y,m+1,0);

  let row = document.createElement("tr");
  let count = 0;

  for(let i=0; i<first.getDay(); i++){
    row.appendChild(document.createElement("td"));
    count++;
  }

  const today = new Date();

  for(let d=1; d<=last.getDate(); d++){
    if(count === 7){
      calBody.appendChild(row);
      row = document.createElement("tr");
      count = 0;
    }

    const td = document.createElement("td");
    const num = document.createElement("div");
    num.className = "day-number";
    num.textContent = d;

    if(today.getFullYear()===y && today.getMonth()===m && today.getDate()===d){
      num.classList.add("today");
    }

    td.appendChild(num);

    const key = dateKey(y,m,d);

    if(events[key]){
      const preview = document.createElement("div");
      preview.className = "record-preview";

      events[key].exercises?.forEach(ex=>{
        if(!ex.exercise) return;
        const part = getBodyPart(ex.exercise);
        const chip = document.createElement("span");
        chip.className = "exercise-chip";
        chip.textContent = ex.exercise;
        chip.style.background = getBodyPartColor(part);
        preview.appendChild(chip);
      });

      td.appendChild(preview);
    }

    td.addEventListener("click",()=>handleDateClick(key));
    row.appendChild(td);
    count++;
  }

  calBody.appendChild(row);
}

/* ------------------------------------------------------
   é€±è¡¨ç¤ºæç”»
------------------------------------------------------ */
function getWeekStart(date){
  const d = new Date(date);
  d.setDate(d.getDate() - d.getDay());
  return d;
}

function renderWeek(){
  const start = getWeekStart(weekDate);
  const end = new Date(start);
  end.setDate(start.getDate()+6);

  weekLabel.textContent = 
    `${start.getFullYear()}/${start.getMonth()+1}/${start.getDate()} ã€œ ${end.getFullYear()}/${end.getMonth()+1}/${end.getDate()}`;

  weekBody.innerHTML = "";

  const tr = document.createElement("tr");

  for(let i=0; i<7; i++){
    const d = new Date(start);
    d.setDate(start.getDate()+i);

    const y=d.getFullYear(), m=d.getMonth(), day=d.getDate();
    const td = document.createElement("td");

    const num = document.createElement("div");
    num.className = "day-number";
    num.textContent = day;
    td.appendChild(num);

    const key = dateKey(y,m,day);

    if(events[key]){
      const preview = document.createElement("div");
      preview.className = "record-preview";
      events[key].exercises?.forEach(ex=>{
        if(!ex.exercise) return;
        const part = getBodyPart(ex.exercise);
        const chip=document.createElement("span");
        chip.className="exercise-chip";
        chip.textContent=ex.exercise;
        chip.style.background=getBodyPartColor(part);
        preview.appendChild(chip);
      });
      td.appendChild(preview);
    }

    td.addEventListener("click",()=>handleDateClick(key));
    tr.appendChild(td);
  }

  weekBody.appendChild(tr);
}

/* ------------------------------------------------------
   ç¨®ç›®ãƒ–ãƒ­ãƒƒã‚¯ç”Ÿæˆ
------------------------------------------------------ */
function createExerciseBlock(data){
  const block = document.createElement("div");
  block.className = "exercise-block";

  const header = document.createElement("div");
  header.style.display = "flex";
  header.style.justifyContent = "space-between";

  const left = document.createElement("div");
  const title = document.createElement("span");
  title.className = "exercise-title";
  title.textContent = "ç¨®ç›®";
  const badge = document.createElement("span");
  badge.className = "body-part-badge";
  badge.style.display="none";

  left.appendChild(title);
  left.appendChild(badge);

  const remove = document.createElement("button");
  remove.className = "remove-exercise";
  remove.textContent = "å‰Šé™¤";
  remove.onclick = ()=>{
    block.remove();
    saveCurrentDay();
  };

  header.appendChild(left);
  header.appendChild(remove);
  block.appendChild(header);

  const sel = document.createElement("select");
  sel.innerHTML = `<option value="">ç¨®ç›®ã‚’é¸æŠ</option>`;
  exerciseCategories.forEach(cat=>{
    const optGroup = document.createElement("optgroup");
    optGroup.label = cat.label;
    cat.items.forEach(item=>{
      const opt = document.createElement("option");
      opt.value = item;
      opt.textContent = item;
      if(data.exercise===item) opt.selected = true;
      optGroup.appendChild(opt);
    });
    sel.appendChild(optGroup);
  });

  sel.onchange = ()=>{
    const part = getBodyPart(sel.value);
    if(part){
      badge.style.display="inline-block";
      badge.textContent = part;
      badge.style.background = getBodyPartColor(part);
    }else{
      badge.style.display="none";
    }
    saveCurrentDay();
  };

  block.appendChild(sel);

  const setsContainer = document.createElement("div");
  block.appendChild(setsContainer);

  if(data.sets?.length){
    data.sets.forEach(s=>{
      setsContainer.appendChild(createSetRow(setsContainer,s));
    });
  } else {
    setsContainer.appendChild(createSetRow(setsContainer,{weight:"",reps:""}));
  }

  const addSetBtn = document.createElement("button");
  addSetBtn.className="add-set-btn";
  addSetBtn.textContent="ï¼‹ ã‚»ãƒƒãƒˆè¿½åŠ ";
  addSetBtn.onclick = ()=>{
    setsContainer.appendChild(createSetRow(setsContainer,{weight:"",reps:""}));
    saveCurrentDay();
  };
  block.appendChild(addSetBtn);

  return block;
}

/* ------------------------------------------------------
   ã‚»ãƒƒãƒˆè¡Œç”Ÿæˆ
------------------------------------------------------ */
function createSetRow(container, data){
  const row = document.createElement("div");
  row.className = "set-row";

  const label = document.createElement("div");
  label.textContent = `ã‚»ãƒƒãƒˆ ${container.children.length+1}`;
  label.style.fontSize="12px";
  label.style.color="#555";
  row.appendChild(label);

  const wrap = document.createElement("div");
  wrap.style.display="flex";
  wrap.style.gap="4px";

  const w = document.createElement("input");
  w.type="number";
  w.placeholder="é‡é‡";
  w.value=data.weight||"";
  w.oninput=saveCurrentDayDebounced;
  wrap.appendChild(w);

  const r = document.createElement("select");
  r.innerHTML=`<option value="">å›æ•°</option>`;
  for(let i=1;i<=20;i++){
    r.innerHTML += `<option value="${i}" ${i==data.reps?"selected":""}>${i}</option>`;
  }
  r.onchange=saveCurrentDay;
  wrap.appendChild(r);

  row.appendChild(wrap);

  const del = document.createElement("button");
  del.className="delete-set-btn";
  del.textContent="ğŸ—‘";
  del.onclick=()=>{
    row.remove();
    saveCurrentDay();
  };
  row.appendChild(del);

  return row;
}

/* ------------------------------------------------------
   ä¿å­˜
------------------------------------------------------ */
function saveCurrentDay(){
  if(!selectedDateKey) return;

  const blocks = [...exerciseList.children];
  const exercises=[];

  blocks.forEach(b=>{
    const sel = b.querySelector("select");
    const setsEls = b.querySelectorAll(".set-row");
    const sets=[...setsEls].map(s=>{
      const inputs = s.querySelectorAll("input,select");
      return {
        weight: inputs[0].value,
        reps: inputs[1].value
      };
    }).filter(s=>s.weight || s.reps);

    if(sel.value || sets.length){
      exercises.push({exercise: sel.value, sets});
    }
  });

  events[selectedDateKey] = {
    exercises,
    note: note.value.trim()
  };

  localStorage.setItem("workout", JSON.stringify(events));
}

let saveTimer=null;
function saveCurrentDayDebounced(){
  clearTimeout(saveTimer);
  saveTimer=setTimeout(saveCurrentDay,300);
}

/* ------------------------------------------------------
   ã‚¹ãƒ¯ã‚¤ãƒ—ãƒ»æœˆç§»å‹•
------------------------------------------------------ */
document.getElementById("prev").onclick=()=>{
  monthDate.setMonth(monthDate.getMonth()-1);
  renderMonth();
};
document.getElementById("next").onclick=()=>{
  monthDate.setMonth(monthDate.getMonth()+1);
  renderMonth();
};

/* ------------------------------------------------------
   é€±ç§»å‹•
------------------------------------------------------ */
document.getElementById("week-prev").onclick=()=>{
  weekDate.setDate(weekDate.getDate()-7);
  renderWeek();
};
document.getElementById("week-next").onclick=()=>{
  weekDate.setDate(weekDate.getDate()+7);
  renderWeek();
};

/* ------------------------------------------------------
   ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰
------------------------------------------------------ */
const menuBtn=document.getElementById("menu-btn");
const menuClose=document.getElementById("menu-close");
const menuOverlay=document.getElementById("menu-overlay");
const menuMonth=document.getElementById("menu-month");
const menuWeek=document.getElementById("menu-week");
const sideMenu=document.getElementById("side-menu");

menuBtn.onclick=()=>{
  sideMenu.classList.add("open");
  menuOverlay.classList.add("open");
};
menuClose.onclick=()=>{
  sideMenu.classList.remove("open");
  menuOverlay.classList.remove("open");
};
menuOverlay.onclick=()=>{
  sideMenu.classList.remove("open");
  menuOverlay.classList.remove("open");
};

/* ------------------------------------------------------
   è¡¨ç¤ºåˆ‡æ›¿ï¼ˆæœˆâ†’é€±ï¼‰
------------------------------------------------------ */
menuMonth.onclick=()=>{
  document.getElementById("month-view").style.display="block";
  document.getElementById("week-view").style.display="none";

  menuMonth.classList.add("active");
  menuWeek.classList.remove("active");

  sideMenu.classList.remove("open");
  menuOverlay.classList.remove("open");

  renderMonth();
};

menuWeek.onclick=()=>{
  document.getElementById("month-view").style.display="none";
  document.getElementById("week-view").style.display="block";

  menuWeek.classList.add("active");
  menuMonth.classList.remove("active");

  sideMenu.classList.remove("open");
  menuOverlay.classList.remove("open");

  renderWeek();
};

/* ------------------------------------------------------
   åˆæœŸæç”»
------------------------------------------------------ */
renderMonth();
renderWeek();
</script>

</body>
</html>
