<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ç­‹ãƒˆãƒ¬ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden; /* ç”»é¢å…¨ä½“ã¯ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ãªã„ */
      font-family: system-ui, sans-serif;
      background: #f7f7f7;
    }

    body {
      display: flex;
      justify-content: center;
    }

    .app {
      position: relative;
      width: 380px;
      max-width: 100%;
      height: 100%;
      box-sizing: border-box;
      background: #f7f7f7;
      z-index: 0;
    }

    .container {
      height: 100%;
      padding: 8px 8px 80px;
      box-sizing: border-box;
      overflow: hidden; /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å´ã‚‚ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ */
    }

    /* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      margin-bottom: 4px;
    }
    .menu-btn {
      border: none;
      background: transparent;
      font-size: 22px;
      padding: 4px 8px 4px 0;
      cursor: pointer;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 4px;
    }

    .month-label {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      flex: 1;
    }

    .nav-btn {
      border: none;
      background: #e0e0e0;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      white-space: nowrap;
      font-size: 13px;
    }

    .month-select {
      font-size: 12px;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background-color: #fff;
    }

    .calendar-wrapper {
      overflow: hidden;
      width: 100%;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      transition: transform 0.0s ease;
    }

    th {
      padding: 4px 0;
      font-size: 13px;
    }
    th:nth-child(1) { color: red; }
    th:nth-child(7) { color: blue; }

    td {
      height: 64px;
      border: 1px solid #eaeaea;
      padding: 4px;
      cursor: pointer;
      background: #fff;
      vertical-align: top;
      box-sizing: border-box;
    }
    td:hover {
      background: #f0f8ff;
    }
    .selected-day {
      background: #fff9c4 !important;
    }

    .day-number {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 12px;
    }
    .day-number.today {
      background-color: rgba(25, 118, 210, 0.16);
      border-radius: 50%;
    }

    .record-preview {
      font-size: 11px;
      margin-top: 4px;
      max-height: 32px;
      overflow: hidden;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .exercise-chip {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      color: #fff;
      white-space: nowrap;
    }

    /* é€±è¡¨ç¤ºç”¨ */
    .week-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
      margin-bottom: 8px;
    }
    .week-label {
      flex: 1;
      text-align: center;
      font-weight: bold;
      font-size: 14px;
    }

    /* ãƒ¡ãƒ¢ã‚·ãƒ¼ãƒˆ */
    .sheet {
      position: fixed;
      left: 50%;
      transform: translateX(-50%) translateY(calc(100% - 24px)); /* ãƒãƒ¼ã ã‘è¦‹ãˆã‚‹çŠ¶æ…‹ */
      width: 380px;
      max-width: 100%;
      background: #fff;
      border-radius: 16px 16px 0 0;
      padding: 8px 16px 16px;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
      box-sizing: border-box;
      max-height: 75vh;
      overflow-y: auto;
      transition: transform 0.3s ease;
      z-index: 20;
    }
    .sheet.open {
      transform: translateX(-50%) translateY(0);
    }

    .sheet-handle {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-bottom: 8px;
      touch-action: pan-y;
    }
    .sheet-handle-bar {
      width: 40px;
      height: 12px; /* æŒ‡å®šã©ãŠã‚Š12px */
      border-radius: 999px;
      background: #ccc;
    }

    .sheet-title {
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .exercise-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .exercise-block {
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 8px;
      background: #fafafa;
    }

    .exercise-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 4px;
    }

    .exercise-title {
      font-size: 13px;
      font-weight: 600;
    }

    .body-part-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      color: #fff;
      margin-left: 4px;
    }

    .remove-exercise {
      font-size: 12px;
      border: none;
      background: transparent;
      color: #d32f2f;
      cursor: pointer;
    }

    .exercise-select-wrapper select {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 13px;
      background-color: #fff;
      box-sizing: border-box;
    }

    .sets-container {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .set-row {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 6px 32px 6px 6px;
      background: #fff;
      position: relative;
    }

    .set-label {
      font-size: 12px;
      margin-bottom: 3px;
      color: #555;
    }

    .set-fields {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .set-fields input,
    .set-fields select {
      font-size: 12px;
      padding: 4px;
      border-radius: 6px;
      border: 1px solid #ccc;
      flex: 1;
      box-sizing: border-box;
    }

    .delete-set-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      background: none;
      border: none;
      font-size: 16px;
      color: #d32f2f;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .add-set-btn {
      margin-top: 6px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px dashed #999;
      background: #fff;
      color: #555;
      font-size: 11px;
      cursor: pointer;
    }

    .add-exercise-btn {
      width: 100%;
      margin-top: 4px;
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 999px;
      border: 1px dashed #1976d2;
      background: #e3f2fd;
      color: #1976d2;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }

    .note-row {
      margin-top: 8px;
    }
    .note-row textarea {
      width: 100%;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 13px;
      resize: vertical;
    }

    /* ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    .side-menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.25);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 30;
    }
    .side-menu-overlay.open {
      opacity: 1;
      pointer-events: auto; /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹ã„ã¦ã‚‹é–“ã¯ã“ã“ã§ã‚¿ãƒƒãƒ—ã‚’å—ã‘ã‚‹ */
    }

    .side-menu {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: 70vw;
      max-width: 280px;
      background: #ffffff;
      box-shadow: 2px 0 10px rgba(0,0,0,0.2);
      transform: translateX(-100%);
      transition: transform 0.2s ease;
      box-sizing: border-box;
      padding: 16px 12px;
      z-index: 40;
    }
    .side-menu.open {
      transform: translateX(0);
    }

    .side-menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .side-menu-title {
      font-weight: bold;
      font-size: 16px;
    }

    .side-menu-close {
      border: none;
      background: transparent;
      font-size: 16px;
      cursor: pointer;
    }

    .side-menu-item {
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      margin-bottom: 4px;
    }
    .side-menu-item.active {
      background: #e3f2fd;
      color: #1976d2;
      font-weight: 600;
    }

  </style>
</head>

<body>
<div class="app">
  <!-- ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
  <div id="side-menu-overlay" class="side-menu-overlay"></div>
  <div id="side-menu" class="side-menu">
    <div class="side-menu-header">
      <div class="side-menu-title">è¡¨ç¤ºåˆ‡æ›¿</div>
      <button id="menu-close" class="side-menu-close">â–²</button>
    </div>
    <div id="menu-month" class="side-menu-item active">æœˆè¡¨ç¤º</div>
    <div id="menu-week" class="side-menu-item">é€±è¡¨ç¤º</div>
  </div>

  <div class="container">
    <div class="top-bar">
      <button id="menu-btn" class="menu-btn">â˜°</button>
    </div>

    <!-- æœˆè¡¨ç¤º -->
    <div id="month-view">
      <div class="calendar-header">
        <button id="prev" class="nav-btn">ï¼œ</button>
        <div class="month-label" id="month-label"></div>
        <select id="month-select" class="month-select"></select>
        <button id="next" class="nav-btn">ï¼</button>
      </div>

      <div class="calendar-wrapper" id="calendar-wrapper">
        <table id="calendar-table">
          <thead>
            <tr>
              <th>æ—¥</th><th>æœˆ</th><th>ç«</th><th>æ°´</th>
              <th>æœ¨</th><th>é‡‘</th><th>åœŸ</th>
            </tr>
          </thead>
          <tbody id="calendar-body"></tbody>
        </table>
      </div>
    </div>

    <!-- é€±è¡¨ç¤º -->
    <div id="week-view" style="display:none;">
      <div class="calendar-header">
        <button id="week-prev" class="nav-btn">ï¼œ</button>
        <div class="week-label" id="week-label"></div>
        <button id="week-next" class="nav-btn">ï¼</button>
      </div>

      <div class="calendar-wrapper" id="week-wrapper">
        <table id="week-table">
          <thead>
            <tr>
              <th>æ—¥</th><th>æœˆ</th><th>ç«</th><th>æ°´</th>
              <th>æœ¨</th><th>é‡‘</th><th>åœŸ</th>
            </tr>
          </thead>
          <tbody id="week-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ãƒ¡ãƒ¢ã‚·ãƒ¼ãƒˆ -->
  <div id="sheet" class="sheet">
    <div class="sheet-handle" id="sheet-handle">
      <div class="sheet-handle-bar"></div>
    </div>
    <div id="sheet-title" class="sheet-title"></div>

    <div id="exercise-list" class="exercise-list"></div>

    <button id="add-exercise" class="add-exercise-btn">ï¼‹ ç¨®ç›®ã‚’è¿½åŠ </button>

    <div class="note-row">
      <textarea id="note" placeholder="ãã®ä»–ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰"></textarea>
    </div>
  </div>
</div>

<script>
/* ------------------------------------------------------
   åŸºæœ¬ãƒ‡ãƒ¼ã‚¿
------------------------------------------------------ */
let monthDate = new Date();   // æœˆè¡¨ç¤ºç”¨
let weekDate = new Date();    // é€±è¡¨ç¤ºç”¨ã®åŸºæº–æ—¥
const events = JSON.parse(localStorage.getItem("workout") || "{}");

const monthLabel = document.getElementById("month-label");
const monthSelect = document.getElementById("month-select");
const calBody = document.getElementById("calendar-body");
const weekBody = document.getElementById("week-body");
const weekLabel = document.getElementById("week-label");

const sheet = document.getElementById("sheet");
const sheetHandle = document.getElementById("sheet-handle");
const note = document.getElementById("note");
const sheetTitle = document.getElementById("sheet-title");
const exerciseList = document.getElementById("exercise-list");
const addExerciseBtn = document.getElementById("add-exercise");
const calendarTable = document.getElementById("calendar-table");
const monthView = document.getElementById("month-view");

const sideMenu = document.getElementById("side-menu");
const sideMenuOverlay = document.getElementById("side-menu-overlay");
const menuBtn = document.getElementById("menu-btn");
const menuClose = document.getElementById("menu-close");
const menuMonth = document.getElementById("menu-month");
const menuWeek = document.getElementById("menu-week");

let viewMode = "month"; // "month" or "week"
let selectedDateKey = "";
let noteDebounceTimer = null;

const repsMax = 20;

/* éƒ¨ä½ï¼†è‰²ãƒãƒƒãƒ— */
const exerciseCategories = [
  { label: "èƒ¸", color: "#e91e63", items: ["ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹","ãƒ€ãƒ³ãƒ™ãƒ«ãƒ—ãƒ¬ã‚¹","ã‚¤ãƒ³ã‚¯ãƒ©ã‚¤ãƒ³ã‚¹ãƒŸã‚¹ãƒ—ãƒ¬ã‚¹","ãƒšãƒƒã‚¯ãƒ•ãƒ©ã‚¤"] },
  { label: "èƒŒä¸­", color: "#3f51b5", items: ["æ‡¸å‚","ãƒ©ãƒƒãƒˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³","ã‚·ãƒ¼ãƒ†ãƒƒãƒ‰ãƒ­ãƒ¼","ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ","ãƒ•ã‚§ã‚¤ã‚¹ãƒ—ãƒ«"] },
  { label: "è¶³", color: "#4caf50", items: ["ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ","ãƒ«ãƒ¼ãƒãƒ‹ã‚¢ãƒ³ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ","ãƒ–ãƒ«ã‚¬ãƒªã‚¢ãƒ³ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ","ãƒ’ãƒƒãƒ—ã‚¢ãƒ€ã‚¯ã‚·ãƒ§ãƒ³"] },
  { label: "è‚©", color: "#ff9800", items: ["ã‚·ãƒ§ãƒ«ãƒ€ãƒ¼ãƒ—ãƒ¬ã‚¹","ãƒªã‚¢ãƒ‡ãƒ«ãƒˆ","ã‚µã‚¤ãƒ‰ãƒ¬ã‚¤ã‚º"] },
  { label: "è…•", color: "#9c27b0", items: ["ã‚¤ãƒ³ã‚¯ãƒ©ã‚¤ãƒ³ãƒ€ãƒ³ãƒ™ãƒ«ã‚«ãƒ¼ãƒ«","ã‚±ãƒ¼ãƒ–ãƒ«ãƒ—ãƒ¬ã‚¹ãƒ€ã‚¦ãƒ³","ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³"] }
];

function dateKey(y, m, d) {
  return `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
}

function normalizeEvent(raw) {
  if (!raw) return { exercises: [], note: "" };
  if (typeof raw === "string") return { exercises: [], note: raw };

  const exs = (raw.exercises || []).map(e => ({
    exercise: e.exercise || "",
    sets: (e.sets || []).map(s => ({
      weight: s.weight || "",
      reps: s.reps || ""
    }))
  }));

  return { exercises: exs, note: raw.note || "" };
}

function getBodyPart(exName) {
  for (const cat of exerciseCategories) {
    if (cat.items.includes(exName)) return cat.label;
  }
  return null;
}
function getBodyPartColor(label) {
  const cat = exerciseCategories.find(c => c.label === label);
  return cat ? c.color : "#999";
}

/* ------------------------------------------------------
   å¹´æœˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–
------------------------------------------------------ */
(function initMonthSelect() {
  const baseYear = new Date().getFullYear();
  const startYear = baseYear - 5;
  const endYear = baseYear + 5;
  for (let y = startYear; y <= endYear; y++) {
    for (let m = 0; m < 12; m++) {
      const opt = document.createElement("option");
      const value = `${y}-${String(m+1).padStart(2,"0")}`;
      opt.value = value;
      opt.textContent = `${y}å¹´ ${m+1}æœˆ`;
      monthSelect.appendChild(opt);
    }
  }

  monthSelect.addEventListener("change", () => {
    const [yStr, mStr] = monthSelect.value.split("-");
    const y = parseInt(yStr, 10);
    const m = parseInt(mStr, 10) - 1;
    monthDate = new Date(y, m, 1);
    renderMonth();
  });
})();

/* ------------------------------------------------------
   ãƒ¬ãƒƒãƒ—æ•°ã‚»ãƒ¬ã‚¯ãƒˆ
------------------------------------------------------ */
function fillRepsSelect(sel, selected) {
  sel.innerHTML = "";
  sel.innerHTML += `<option value="">ãƒ¬ãƒƒãƒ—æ•°</option>`;
  for (let i = 1; i <= repsMax; i++) {
    sel.innerHTML += `<option value="${i}" ${String(selected)===String(i)?"selected":""}>${i}å›</option>`;
  }
}

/* ------------------------------------------------------
   ç¨®ç›®ã‚»ãƒ¬ã‚¯ãƒˆ
------------------------------------------------------ */
function createExerciseSelect(selected) {
  const sel = document.createElement("select");
  sel.className = "exercise-select";

  sel.innerHTML = `<option value="">ç¨®ç›®ã‚’é¸æŠ</option>`;

  exerciseCategories.forEach(cat => {
    const grp = document.createElement("optgroup");
    grp.label = cat.label;
    cat.items.forEach(item => {
      const opt = document.createElement("option");
      opt.value = item;
      opt.textContent = item;
      if (item === selected) opt.selected = true;
      grp.appendChild(opt);
    });
    sel.appendChild(grp);
  });

  return sel;
}

/* ------------------------------------------------------
   ã‚»ãƒƒãƒˆè¡Œï¼ˆé‡é‡ã¯æ•°å€¤å…¥åŠ›ãƒ»ğŸ—‘å‰Šé™¤ï¼‰
------------------------------------------------------ */
function createSetRow(container, data) {
  const row = document.createElement("div");
  row.className = "set-row";

  const label = document.createElement("div");
  label.className = "set-label";
  label.textContent = "ã‚»ãƒƒãƒˆ";
  row.appendChild(label);

  const fields = document.createElement("div");
  fields.className = "set-fields";

  const weightInput = document.createElement("input");
  weightInput.type = "number";
  weightInput.inputMode = "decimal";
  weightInput.className = "weight-input";
  weightInput.placeholder = "é‡é‡(kg)";
  weightInput.value = data.weight || "";

  const repsSel = document.createElement("select");
  repsSel.className = "reps-select";
  fillRepsSelect(repsSel, data.reps);

  fields.appendChild(weightInput);
  fields.appendChild(repsSel);
  row.appendChild(fields);

  const del = document.createElement("button");
  del.className = "delete-set-btn";
  del.innerHTML = "ğŸ—‘";
  del.addEventListener("click", () => {
    row.remove();
    renumberSets(container);

    if (container.children.length === 0) {
      container.appendChild(createSetRow(container, {weight:"", reps:""}));
      renumberSets(container);
    }

    saveCurrentDay();
  });
  row.appendChild(del);

  return row;
}

function renumberSets(container) {
  const rows = container.querySelectorAll(".set-row");
  rows.forEach((row, i) => {
    row.querySelector(".set-label").textContent = `ã‚»ãƒƒãƒˆ ${i+1}`;
  });
}

/* ------------------------------------------------------
   ç¨®ç›®ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆéƒ¨ä½ãƒãƒƒã‚¸ä»˜ãï¼‰
------------------------------------------------------ */
function updateExerciseBlockBodyPart(block) {
  const select = block.querySelector(".exercise-select");
  const badge = block.querySelector(".body-part-badge");
  if (!select || !badge) return;
  const name = select.value;
  const part = getBodyPart(name);
  if (part) {
    badge.textContent = part;
    badge.style.backgroundColor = getBodyPartColor(part);
    badge.style.display = "inline-block";
  } else {
    badge.textContent = "";
    badge.style.display = "none";
  }
}

function createExerciseBlock(data) {
  const block = document.createElement("div");
  block.className = "exercise-block";

  const header = document.createElement("div");
  header.className = "exercise-header";

  const leftHeader = document.createElement("div");

  const title = document.createElement("span");
  title.className = "exercise-title";
  title.textContent = "ç¨®ç›®";

  const badge = document.createElement("span");
  badge.className = "body-part-badge";
  badge.style.display = "none";

  leftHeader.appendChild(title);
  leftHeader.appendChild(badge);

  const del = document.createElement("button");
  del.className = "remove-exercise";
  del.textContent = "å‰Šé™¤";
  del.addEventListener("click", () => {
    block.remove();
    saveCurrentDay();
  });

  header.appendChild(leftHeader);
  header.appendChild(del);
  block.appendChild(header);

  const wrap = document.createElement("div");
  wrap.className = "exercise-select-wrapper";
  const exSel = createExerciseSelect(data.exercise);
  wrap.appendChild(exSel);
  block.appendChild(wrap);

  const sets = document.createElement("div");
  sets.className = "sets-container";
  block.appendChild(sets);

  if (data.sets?.length) {
    data.sets.forEach(s => sets.appendChild(createSetRow(sets, s)));
  } else {
    sets.appendChild(createSetRow(sets, {weight:"", reps:""}));
  }
  renumberSets(sets);

  updateExerciseBlockBodyPart(block);

  const addSetBtn = document.createElement("button");
  addSetBtn.className = "add-set-btn";
  addSetBtn.textContent = "ï¼‹ ã‚»ãƒƒãƒˆè¿½åŠ ";
  addSetBtn.addEventListener("click", () => {
    sets.appendChild(createSetRow(sets, {weight:"", reps:""}));
    renumberSets(sets);
    saveCurrentDay();
  });
  block.appendChild(addSetBtn);

  return block;
}

/* ------------------------------------------------------
   ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–
------------------------------------------------------ */
function saveCurrentDay() {
  if (!selectedDateKey) return;

  const blocks = [...document.querySelectorAll(".exercise-block")];
  const exercises = [];

  blocks.forEach(b => {
    const ex = b.querySelector(".exercise-select").value;

    const setRows = b.querySelectorAll(".set-row");
    const sets = [...setRows].map(row => ({
      weight: row.querySelector(".weight-input").value,
      reps: row.querySelector(".reps-select").value
    })).filter(s => s.weight || s.reps);

    if (ex || sets.length > 0) exercises.push({ exercise: ex, sets });
  });

  const noteText = note.value.trim();

  if (exercises.length > 0 || noteText) {
    events[selectedDateKey] = { exercises, note: noteText };
  } else {
    delete events[selectedDateKey];
  }

  localStorage.setItem("workout", JSON.stringify(events));
  renderCurrentView();
}

function saveCurrentDayDebounced() {
  clearTimeout(noteDebounceTimer);
  noteDebounceTimer = setTimeout(saveCurrentDay, 500);
}

/* ------------------------------------------------------
   æ—¥ä»˜ã‚¯ãƒªãƒƒã‚¯ â†’ ãƒ¡ãƒ¢æ¬„é–‹ãï¼ˆï¼‹åŒã˜æ—¥ã§ã‚‚é–‹ãã‚ˆã†ã«ä¿®æ­£ï¼‰
------------------------------------------------------ */
function handleDateClick(key) {
  selectedDateKey = key;
  openSheet(key);
}

function openSheet(key) {
  const data = normalizeEvent(events[key]);

  sheetTitle.textContent = `${key} ã®ç­‹ãƒˆãƒ¬`;
  exerciseList.innerHTML = "";

  if (data.exercises.length) {
    data.exercises.forEach(ex => exerciseList.appendChild(createExerciseBlock(ex)));
  } else {
    exerciseList.appendChild(createExerciseBlock({}));
  }

  note.value = data.note || "";

  sheet.classList.add("open");
  renderCurrentView();
}

/* ------------------------------------------------------
   å…¥åŠ›ç›£è¦–
------------------------------------------------------ */
addExerciseBtn.addEventListener("click", () => {
  exerciseList.appendChild(createExerciseBlock({}));
  saveCurrentDay();
});

sheet.addEventListener("change", e => {
  if (e.target.matches("select")) {
    if (e.target.matches(".exercise-select")) {
      const block = e.target.closest(".exercise-block");
      if (block) updateExerciseBlockBodyPart(block);
    }
    saveCurrentDay();
  }
});

sheet.addEventListener("input", e => {
  if (e.target.matches(".weight-input")) {
    saveCurrentDayDebounced();
  }
});

note.addEventListener("input", () => saveCurrentDayDebounced());

/* ------------------------------------------------------
   ãƒ¡ãƒ¢ã‚·ãƒ¼ãƒˆã®ä¸Šä¸‹ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆãƒãƒ³ãƒ‰ãƒ«ï¼‰
------------------------------------------------------ */
let sheetStartY = 0;
let sheetDragging = false;

sheetHandle.addEventListener("touchstart", (e) => {
  if (e.touches.length !== 1) return;
  sheetStartY = e.touches[0].clientY;
  sheetDragging = true;
});

sheetHandle.addEventListener("touchmove", (e) => {
  if (!sheetDragging) return;
});

sheetHandle.addEventListener("touchend", (e) => {
  if (!sheetDragging) return;
  sheetDragging = false;
  const endY = e.changedTouches[0].clientY;
  const dy = endY - sheetStartY;
  const threshold = 40;
  if (dy > threshold && sheet.classList.contains("open")) {
    // ä¸‹ã‚¹ãƒ¯ã‚¤ãƒ— â†’ åç´ï¼ˆãƒãƒ¼ã ã‘ï¼‰
    sheet.classList.remove("open");
  } else if (dy < -threshold && !sheet.classList.contains("open")) {
    // ä¸Šã‚¹ãƒ¯ã‚¤ãƒ— â†’ å…¨é–‹
    sheet.classList.add("open");
  }
});

/* ------------------------------------------------------
   ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ¨ªã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆæœˆè¡¨ç¤ºã®ã¿ãƒ»ç¸¦ã¯ç„¡è¦–ï¼‰
------------------------------------------------------ */
let swipeStartX = 0;
let swipeStartY = 0;
let isSwiping = false;

monthView.addEventListener("touchstart", (e) => {
  if (viewMode !== "month") return;
  if (e.touches.length !== 1) return;
  const t = e.touches[0];
  swipeStartX = t.clientX;
  swipeStartY = t.clientY;
  isSwiping = true;
  calendarTable.style.transition = "none";
});

monthView.addEventListener("touchmove", (e) => {
  if (!isSwiping || viewMode !== "month") return;
  const t = e.touches[0];
  const dx = t.clientX - swipeStartX;
  const dy = t.clientY - swipeStartY;

  if (Math.abs(dy) > Math.abs(dx)) return; // ç¸¦ã®å‹•ãã¯å®Œå…¨ç„¡è¦–

  calendarTable.style.transform = `translateX(${dx}px)`;
});

monthView.addEventListener("touchend", (e) => {
  if (!isSwiping || viewMode !== "month") return;
  isSwiping = false;

  const t = e.changedTouches[0];
  const dx = t.clientX - swipeStartX;
  const dy = t.clientY - swipeStartY;

  calendarTable.style.transition = "transform 0.2s ease";

  const threshold = 60;

  if (Math.abs(dx) > threshold && Math.abs(dx) > Math.abs(dy)) {
    if (dx < 0) {
      // å·¦ã‚¹ãƒ¯ã‚¤ãƒ— â†’ æ¬¡ã®æœˆ
      calendarTable.style.transform = "translateX(-100%)";
      setTimeout(() => {
        monthDate.setMonth(monthDate.getMonth() + 1);
        renderMonth();
        calendarTable.style.transition = "none";
        calendarTable.style.transform = "translateX(100%)";
        requestAnimationFrame(() => {
          calendarTable.style.transition = "transform 0.2s ease";
          calendarTable.style.transform = "translateX(0)";
        });
      }, 200);
    } else {
      // å³ã‚¹ãƒ¯ã‚¤ãƒ— â†’ å‰ã®æœˆ
      calendarTable.style.transform = "translateX(100%)";
      setTimeout(() => {
        monthDate.setMonth(monthDate.getMonth() - 1);
        renderMonth();
        calendarTable.style.transition = "none";
        calendarTable.style.transform = "translateX(-100%)";
        requestAnimationFrame(() => {
          calendarTable.style.transition = "transform 0.2s ease";
          calendarTable.style.transform = "translateX(0)";
        });
      }, 200);
    }
  } else {
    calendarTable.style.transform = "translateX(0)";
  }
});

/* ------------------------------------------------------
   ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰ & è¡¨ç¤ºåˆ‡æ›¿
------------------------------------------------------ */
function openSideMenu() {
  sideMenu.classList.add("open");
  sideMenuOverlay.classList.add("open");
}
function closeSideMenu() {
  sideMenu.classList.remove("open");
  sideMenuOverlay.classList.remove("open");
}

menuBtn.addEventListener("click", openSideMenu);
menuClose.addEventListener("click", closeSideMenu);
sideMenuOverlay.addEventListener("click", closeSideMenu);

menuMonth.addEventListener("click", () => {
  viewMode = "month";
  document.getElementById("month-view").style.display = "block";
  document.getElementById("week-view").style.display = "none";
  menuMonth.classList.add("active");
  menuWeek.classList.remove("active");
  closeSideMenu();
  renderMonth();
});

menuWeek.addEventListener("click", () => {
  viewMode = "week";
  document.getElementById("month-view").style.display = "none";
  document.getElementById("week-view").style.display = "block";
  menuWeek.classList.add("active");
  menuMonth.classList.remove("active");
  closeSideMenu();
  renderWeek();
});

/* ------------------------------------------------------
   ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»ï¼ˆç¨®ç›®åã ã‘ãƒãƒƒã‚¸è¡¨ç¤ºï¼‰
------------------------------------------------------ */
function updateMonthUI() {
  const y = monthDate.getFullYear();
  const m = monthDate.getMonth();
  monthLabel.textContent = `${y}å¹´ ${m+1}æœˆ`;
  const value = `${y}-${String(m+1).padStart(2,"0")}`;
  if ([...monthSelect.options].some(o => o.value === value)) {
    monthSelect.value = value;
  }
}

function fillPreview(container, raw) {
  container.innerHTML = "";
  const data = normalizeEvent(raw);
  if (!data.exercises.length) return;

  data.exercises.forEach(ex => {
    if (!ex.exercise) return;
    const part = getBodyPart(ex.exercise);
    const chip = document.createElement("span");
    chip.className = "exercise-chip";
    chip.textContent = ex.exercise;
    chip.style.backgroundColor = part ? getBodyPartColor(part) : "#999";
    container.appendChild(chip);
  });
}

function renderMonth() {
  const y = monthDate.getFullYear();
  const m = monthDate.getMonth();

  updateMonthUI();
  calBody.innerHTML = "";

  const first = new Date(y, m, 1);
  const last = new Date(y, m+1, 0);

  let row = document.createElement("tr");
  let count = 0;

  // æ—¥æ›œå§‹ã¾ã‚Š
  for (let i = 0; i < first.getDay(); i++) {
    row.appendChild(document.createElement("td"));
    count++;
  }

  const today = new Date();
  const isThisMonth = today.getFullYear()===y && today.getMonth()===m;

  for (let d = 1; d <= last.getDate(); d++) {
    if (count === 7) {
      calBody.appendChild(row);
      row = document.createElement("tr");
      count = 0;
    }

    const cell = document.createElement("td");

    const num = document.createElement("div");
    num.className = "day-number";
    num.textContent = d;

    const weekday = (first.getDay() + (d-1)) % 7;
    if (weekday===0) num.style.color = "red";
    if (weekday===6) num.style.color = "blue";

    if (isThisMonth && today.getDate()===d) {
      num.classList.add("today");
    }
    cell.appendChild(num);

    const key = dateKey(y,m,d);
    if (key===selectedDateKey) cell.classList.add("selected-day");

    if (events[key]) {
      const preview = document.createElement("div");
      preview.className = "record-preview";
      fillPreview(preview, events[key]);
      cell.appendChild(preview);
    }

    cell.addEventListener("click", () => handleDateClick(key));

    row.appendChild(cell);
    count++;
  }

  calBody.appendChild(row);
}

/* ------------------------------------------------------
   é€±è¡¨ç¤ºï¼ˆæ—¥æ›œå§‹ã¾ã‚Š 1è¡Œï¼‰
------------------------------------------------------ */
function getWeekStart(date) {
  const d = new Date(date);
  const day = d.getDay(); // 0:æ—¥
  d.setHours(0,0,0,0);
  d.setDate(d.getDate() - day);
  return d;
}

function renderWeek() {
  const weekStart = getWeekStart(weekDate);
  const weekEnd = new Date(weekStart);
  weekEnd.setDate(weekStart.getDate() + 6);

  const startStr = `${weekStart.getFullYear()}å¹´${weekStart.getMonth()+1}æœˆ${weekStart.getDate()}æ—¥`;
  const endStrMonth = weekEnd.getMonth()+1;
  const endStr = `${weekEnd.getFullYear()}å¹´${endStrMonth}æœˆ${weekEnd.getDate()}æ—¥`;
  weekLabel.textContent = `${startStr} ã€œ ${endStr}`;

  weekBody.innerHTML = "";

  const row = document.createElement("tr");
  const today = new Date();

  for (let i = 0; i < 7; i++) {
    const d = new Date(weekStart);
    d.setDate(weekStart.getDate() + i);

    const y = d.getFullYear();
    const m = d.getMonth();
    const day = d.getDate();

    const cell = document.createElement("td");

    const num = document.createElement("div");
    num.className = "day-number";
    num.textContent = day;

    if (i === 0) num.style.color = "red";
    if (i === 6) num.style.color = "blue";

    if (today.getFullYear()===y && today.getMonth()===m && today.getDate()===day) {
      num.classList.add("today");
    }

    cell.appendChild(num);

    const key = dateKey(y,m,day);
    if (key===selectedDateKey) cell.classList.add("selected-day");

    if (events[key]) {
      const preview = document.createElement("div");
      preview.className = "record-preview";
      fillPreview(preview, events[key]);
      cell.appendChild(preview);
    }

    cell.addEventListener("click", () => handleDateClick(key));

    row.appendChild(cell);
  }

  weekBody.appendChild(row);
}

/* é€±ã®å‰å¾Œç§»å‹• */
document.getElementById("week-prev").onclick = () => {
  weekDate.setDate(weekDate.getDate() - 7);
  renderWeek();
};
document.getElementById("week-next").onclick = () => {
  weekDate.setDate(weekDate.getDate() + 7);
  renderWeek();
};

/* ------------------------------------------------------
   æœˆç§»å‹•ãƒœã‚¿ãƒ³
------------------------------------------------------ */
document.getElementById("prev").onclick = () => {
  monthDate.setMonth(monthDate.getMonth()-1);
  renderMonth();
};
document.getElementById("next").onclick = () => {
  monthDate.setMonth(monthDate.getMonth()+1);
  renderMonth();
};

/* ------------------------------------------------------
   ä»Šã®ãƒ“ãƒ¥ãƒ¼ã‚’å†æç”»
------------------------------------------------------ */
function renderCurrentView() {
  if (viewMode === "month") {
    renderMonth();
  } else {
    renderWeek();
  }
}

/* åˆæœŸæç”» */
renderMonth();
weekDate = new Date(); // é€±è¡¨ç¤ºç”¨ã®åˆæœŸå€¤
</script>

</body>
</html>
