<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Á≠ã„Éà„É¨„Ç´„É¨„É≥„ÉÄ„Éº</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      background: #f7f7f7;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app {
      position: relative;
      width: 380px;
      max-width: 100%;
      height: 100%;
      background: #f7f7f7;
      overflow: hidden;
    }

    .container {
      height: 100%;
      padding: 8px;
      overflow: hidden;
      box-sizing: border-box;
    }

    /* --- „É°„Éã„É•„Éº --- */
    .top-bar {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }
    .menu-btn {
      font-size: 22px;
      background: transparent;
      border: none;
      padding: 4px;
      cursor: pointer;
    }

    .side-menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      z-index: 30;
    }
    .side-menu-overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    .side-menu {
      position: fixed;
      top: 0;
      left: 0;
      width: 70%;
      max-width: 280px;
      height: 100%;
      background: #fff;
      transform: translateX(-100%);
      transition: transform 0.25s;
      padding: 16px;
      z-index: 40;
      box-shadow: 2px 0 10px rgba(0,0,0,0.3);
      box-sizing: border-box;
    }
    .side-menu.open {
      transform: translateX(0);
    }

    .side-menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .side-menu-title {
      font-size: 16px;
      font-weight: bold;
    }
    .side-menu-close {
      border: none;
      background: transparent;
      font-size: 16px;
      cursor: pointer;
    }

    .side-menu-item {
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      margin-bottom: 4px;
    }
    .side-menu-item.active {
      background: #e3f2fd;
      color: #1976d2;
      font-weight: bold;
    }

    /* --- „Ç´„É¨„É≥„ÉÄ„Éº --- */
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
      margin-bottom: 5px;
    }

    .nav-btn {
      border: none;
      background: #e0e0e0;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
    }

    .month-label {
      flex: 1;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
    }

    .calendar-wrapper {
      overflow: hidden;
      width: 100%;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      transition: transform 0.2s ease;
    }

    th {
      font-size: 13px;
      padding: 4px 0;
    }
    th:nth-child(1) { color: red; }
    th:nth-child(7) { color: blue; }

    td {
      height: 60px;
      border: 1px solid #ddd;
      vertical-align: top;
      padding: 4px;
      background: #fff;
      cursor: pointer;
    }

    .day-number {
      font-weight: bold;
      font-size: 12px;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .today {
      background: rgba(25,118,210,0.16);
      border-radius: 50%;
    }
    .selected-day {
      background: #fff9c4 !important;
    }

    .record-preview {
      font-size: 11px;
      margin-top: 2px;
      max-height: 32px;
      overflow: hidden;
      display: flex;
      flex-wrap: wrap;
      gap: 2px;
    }

    .exercise-chip {
      display: inline-block;
      padding: 2px 6px;
      font-size: 10px;
      border-radius: 999px;
      color: #fff;
      white-space: nowrap;
    }

    /* --- „É°„É¢„Ç∑„Éº„Éà --- */
    .sheet {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      margin: 0 auto;
      max-width: 380px;
      background: #fff;
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -4px 10px rgba(0,0,0,0.2);
      box-sizing: border-box;
      max-height: 75vh;
      overflow-y: auto;
      transition: height 0.25s;
    }

    .sheet.closed {
      height: 24px;
      overflow: hidden;
      padding: 6px 12px 6px;
    }

    .sheet.open {
      height: auto;
      padding: 8px 12px 12px;
    }

    .sheet-handle {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-bottom: 6px;
      touch-action: pan-y;
    }
    .sheet-handle-bar {
      width: 40px;
      height: 12px;
      border-radius: 6px;
      background: #ccc;
    }

    .sheet-title {
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .exercise-block {
      background: #fafafa;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 8px;
      margin-bottom: 8px;
    }

    .exercise-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .exercise-title {
      font-size: 13px;
      font-weight: bold;
    }

    .body-part-badge {
      padding: 2px 6px;
      font-size: 10px;
      border-radius: 999px;
      color: #fff;
      margin-left: 4px;
    }

    .remove-exercise {
      color: #d32f2f;
      background: none;
      border: none;
      font-size: 12px;
      cursor: pointer;
    }

    .set-row {
      position: relative;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 6px 30px 6px 6px;
      margin-top: 6px;
      background: #fff;
    }

    .set-label {
      font-size: 12px;
      color: #555;
      margin-bottom: 2px;
    }

    .set-fields {
      display: flex;
      gap: 4px;
    }
    .set-fields input,
    .set-fields select {
      flex: 1;
      font-size: 12px;
      padding: 4px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    .delete-set-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      font-size: 16px;
      color: #d32f2f;
      border: none;
      background: none;
      cursor: pointer;
    }

    .add-set-btn,
    .add-exercise-btn {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px dashed #999;
      background: #fff;
      font-size: 12px;
      cursor: pointer;
      margin-top: 6px;
    }
    .add-exercise-btn {
      width: 100%;
      border-color: #1976d2;
      color: #1976d2;
      background: #e3f2fd;
      font-weight: 600;
      margin-top: 8px;
    }

    #note {
      width: 100%;
      margin-top: 8px;
      font-size: 13px;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
<div class="app">
  <!-- „É°„Éã„É•„Éº„ÅÆ„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
  <div id="menu-overlay" class="side-menu-overlay"></div>

  <!-- „Çµ„Ç§„Éâ„É°„Éã„É•„Éº -->
  <div id="side-menu" class="side-menu">
    <div class="side-menu-header">
      <div class="side-menu-title">Ë°®Á§∫ÂàáÊõø</div>
      <button id="menu-close" class="side-menu-close">‚ñ≤</button>
    </div>
    <div id="menu-month" class="side-menu-item active">ÊúàË°®Á§∫</div>
    <div id="menu-week" class="side-menu-item">ÈÄ±Ë°®Á§∫</div>
  </div>

  <div class="container">
    <div class="top-bar">
      <button id="menu-btn" class="menu-btn">‚ò∞</button>
    </div>

    <!-- ÊúàË°®Á§∫ -->
    <div id="month-view">
      <div class="calendar-header">
        <button id="prev" class="nav-btn">Ôºú</button>
        <div id="month-label" class="month-label"></div>
        <select id="month-select"></select>
        <button id="next" class="nav-btn">Ôºû</button>
      </div>

      <div class="calendar-wrapper" id="calendar-wrapper">
        <table id="calendar-table">
          <thead>
            <tr>
              <th>Êó•</th><th>Êúà</th><th>ÁÅ´</th><th>Ê∞¥</th>
              <th>Êú®</th><th>Èáë</th><th>Âúü</th>
            </tr>
          </thead>
          <tbody id="calendar-body"></tbody>
        </table>
      </div>
    </div>

    <!-- ÈÄ±Ë°®Á§∫ -->
    <div id="week-view" style="display:none;">
      <div class="calendar-header">
        <button id="week-prev" class="nav-btn">Ôºú</button>
        <div id="week-label" class="month-label"></div>
        <button id="week-next" class="nav-btn">Ôºû</button>
      </div>
      <div class="calendar-wrapper">
        <table id="week-table">
          <thead>
            <tr>
              <th>Êó•</th><th>Êúà</th><th>ÁÅ´</th><th>Ê∞¥</th>
              <th>Êú®</th><th>Èáë</th><th>Âúü</th>
            </tr>
          </thead>
          <tbody id="week-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- „É°„É¢„Ç∑„Éº„ÉàÔºàÊúÄÂàù„ÅØ„Ç™„Éº„Éó„É≥Áä∂ÊÖãÔºâ -->
  <div id="sheet" class="sheet open">
    <div id="sheet-handle" class="sheet-handle">
      <div class="sheet-handle-bar"></div>
    </div>
    <div id="sheet-title" class="sheet-title"></div>
    <div id="exercise-list"></div>
    <button id="add-exercise" class="add-exercise-btn">Ôºã Á®ÆÁõÆ„ÇíËøΩÂä†</button>
    <textarea id="note" placeholder="„Åù„ÅÆ‰ªñ„É°„É¢Ôºà‰ªªÊÑèÔºâ"></textarea>
  </div>
</div>

<script>
/* ====== „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ====== */
function pad2(n) {
  return (n < 10 ? "0" : "") + n;
}

function dateKey(y,m,d){
  return y + "-" + pad2(m+1) + "-" + pad2(d);
}

/* ====== Âü∫Êú¨Â§âÊï∞ ====== */
var monthDate = new Date();
var weekDate = new Date();
var selectedDateKey = "";
var viewMode = "month";

var events = JSON.parse(localStorage.getItem("workout") || "{}");

var monthLabel = document.getElementById("month-label");
var monthSelect = document.getElementById("month-select");
var calBody = document.getElementById("calendar-body");
var weekBody = document.getElementById("week-body");
var weekLabel = document.getElementById("week-label");

var sheet = document.getElementById("sheet");
var sheetTitle = document.getElementById("sheet-title");
var exerciseList = document.getElementById("exercise-list");
var note = document.getElementById("note");

var menuBtn = document.getElementById("menu-btn");
var menuClose = document.getElementById("menu-close");
var menuOverlay = document.getElementById("menu-overlay");
var sideMenu = document.getElementById("side-menu");
var menuMonth = document.getElementById("menu-month");
var menuWeek = document.getElementById("menu-week");
var sheetHandle = document.getElementById("sheet-handle");
var monthView = document.getElementById("month-view");
var calendarTable = document.getElementById("calendar-table");

/* Á®ÆÁõÆ„Ç´„ÉÜ„Ç¥„É™ */
var exerciseCategories = [
  { label: "ËÉ∏", color: "#e91e63", items: ["„Éô„É≥„ÉÅ„Éó„É¨„Çπ","„ÉÄ„É≥„Éô„É´„Éó„É¨„Çπ","„Ç§„É≥„ÇØ„É©„Ç§„É≥„Çπ„Éü„Çπ„Éó„É¨„Çπ","„Éö„ÉÉ„ÇØ„Éï„É©„Ç§"] },
  { label: "ËÉå‰∏≠", color: "#3f51b5", items: ["Êá∏ÂûÇ","„É©„ÉÉ„Éà„Éó„É´„ÉÄ„Ç¶„É≥","„Ç∑„Éº„ÉÜ„ÉÉ„Éâ„É≠„Éº","„Éá„ÉÉ„Éâ„É™„Éï„Éà","„Éï„Çß„Ç§„Çπ„Éó„É´"] },
  { label: "Ë∂≥", color: "#4caf50", items: ["„Çπ„ÇØ„ÉØ„ÉÉ„Éà","„É´„Éº„Éû„Éã„Ç¢„É≥„Éá„ÉÉ„Éâ„É™„Éï„Éà","„Éñ„É´„Ç¨„É™„Ç¢„É≥„Çπ„ÇØ„ÉØ„ÉÉ„Éà","„Éí„ÉÉ„Éó„Ç¢„ÉÄ„ÇØ„Ç∑„Éß„É≥"] },
  { label: "ËÇ©", color: "#ff9800", items: ["„Ç∑„Éß„É´„ÉÄ„Éº„Éó„É¨„Çπ","„É™„Ç¢„Éá„É´„Éà","„Çµ„Ç§„Éâ„É¨„Ç§„Ç∫"] },
  { label: "ËÖï", color: "#9c27b0", items: ["„Ç§„É≥„ÇØ„É©„Ç§„É≥„ÉÄ„É≥„Éô„É´„Ç´„Éº„É´","„Ç±„Éº„Éñ„É´„Éó„É¨„Çπ„ÉÄ„Ç¶„É≥","„Ç™„Éº„Éê„Éº„Éò„ÉÉ„Éâ„Ç®„ÇØ„Çπ„ÉÜ„É≥„Ç∑„Éß„É≥"] }
];

function normalizeEvent(raw){
  if (!raw) return { exercises: [], note: "" };
  return {
    exercises: raw.exercises || [],
    note: raw.note || ""
  };
}

function getBodyPart(exName){
  for (var i=0; i<exerciseCategories.length; i++){
    if (exerciseCategories[i].items.indexOf(exName) !== -1){
      return exerciseCategories[i].label;
    }
  }
  return null;
}

function getBodyPartColor(label){
  for (var i=0; i<exerciseCategories.length; i++){
    if (exerciseCategories[i].label === label){
      return exerciseCategories[i].color;
    }
  }
  return "#999";
}

/* ====== „É°„É¢„Ç∑„Éº„ÉàÈñãÈñâ ====== */
function openSheet(key){
  selectedDateKey = key;
  var data = normalizeEvent(events[key]);

  sheetTitle.textContent = key + " „ÅÆÁ≠ã„Éà„É¨";
  exerciseList.innerHTML = "";

  if (data.exercises.length > 0){
    data.exercises.forEach(function(ex){
      exerciseList.appendChild(createExerciseBlock(ex));
    });
  } else {
    exerciseList.appendChild(createExerciseBlock({ exercise: "", sets: [] }));
  }

  note.value = data.note || "";

  sheet.classList.remove("closed");
  sheet.classList.add("open");
}

function closeSheet(){
  sheet.classList.remove("open");
  sheet.classList.add("closed");
}

/* Êó•‰ªò„ÇØ„É™„ÉÉ„ÇØ„ÅßÂøÖ„ÅöÈñã„Åè */
function handleDateClick(key){
  openSheet(key);
}

/* ====== „Ç´„É¨„É≥„ÉÄ„ÉºÔºàÊúàÔºâ ====== */
function initMonthSelect(){
  var baseYear = new Date().getFullYear();
  var startYear = baseYear - 5;
  var endYear = baseYear + 5;
  monthSelect.innerHTML = "";
  for (var y=startYear; y<=endYear; y++){
    for (var m=0; m<12; m++){
      var opt = document.createElement("option");
      var v = y + "-" + pad2(m+1);
      opt.value = v;
      opt.textContent = y + "Âπ¥ " + (m+1) + "Êúà";
      monthSelect.appendChild(opt);
    }
  }
}

function renderMonth(){
  var y = monthDate.getFullYear();
  var m = monthDate.getMonth();

  monthLabel.textContent = y + "Âπ¥ " + (m+1) + "Êúà";
  var value = y + "-" + pad2(m+1);
  monthSelect.value = value;

  calBody.innerHTML = "";

  var first = new Date(y,m,1);
  var last  = new Date(y,m+1,0);
  var row = document.createElement("tr");
  var count = 0;

  for (var i=0; i<first.getDay(); i++){
    row.appendChild(document.createElement("td"));
    count++;
  }

  var today = new Date();

  for (var d=1; d<=last.getDate(); d++){
    if (count === 7){
      calBody.appendChild(row);
      row = document.createElement("tr");
      count = 0;
    }

    var td = document.createElement("td");
    var num = document.createElement("div");
    num.className = "day-number";
    num.textContent = d;

    if (today.getFullYear()===y && today.getMonth()===m && today.getDate()===d){
      num.classList.add("today");
    }
    td.appendChild(num);

    var key = dateKey(y,m,d);
    var ev = events[key];
    if (ev && ev.exercises && ev.exercises.length){
      var preview = document.createElement("div");
      preview.className = "record-preview";
      ev.exercises.forEach(function(ex){
        if (!ex.exercise) return;
        var part = getBodyPart(ex.exercise);
        var chip = document.createElement("span");
        chip.className = "exercise-chip";
        chip.textContent = ex.exercise;
        chip.style.background = getBodyPartColor(part);
        preview.appendChild(chip);
      });
      td.appendChild(preview);
    }

    td.addEventListener("click",(function(k){
      return function(){ handleDateClick(k); };
    })(key));

    row.appendChild(td);
    count++;
  }
  calBody.appendChild(row);
}

/* ====== ÈÄ±Ë°®Á§∫ ====== */
function getWeekStart(date){
  var d = new Date(date);
  d.setHours(0,0,0,0);
  var day = d.getDay();
  d.setDate(d.getDate() - day); // Êó•ÊõúÂßã„Åæ„Çä
  return d;
}

function renderWeek(){
  var start = getWeekStart(weekDate);
  var end = new Date(start);
  end.setDate(start.getDate() + 6);

  weekLabel.textContent =
    start.getFullYear() + "/" + (start.getMonth()+1) + "/" + start.getDate() +
    " „Äú " +
    end.getFullYear() + "/" + (end.getMonth()+1) + "/" + end.getDate();

  weekBody.innerHTML = "";
  var tr = document.createElement("tr");

  for (var i=0; i<7; i++){
    var d = new Date(start);
    d.setDate(start.getDate() + i);
    var y = d.getFullYear();
    var m = d.getMonth();
    var day = d.getDate();

    var td = document.createElement("td");
    var num = document.createElement("div");
    num.className = "day-number";
    num.textContent = day;
    td.appendChild(num);

    var key = dateKey(y,m,day);
    var ev = events[key];
    if (ev && ev.exercises && ev.exercises.length){
      var preview = document.createElement("div");
      preview.className = "record-preview";
      ev.exercises.forEach(function(ex){
        if (!ex.exercise) return;
        var part = getBodyPart(ex.exercise);
        var chip = document.createElement("span");
        chip.className = "exercise-chip";
        chip.textContent = ex.exercise;
        chip.style.background = getBodyPartColor(part);
        preview.appendChild(chip);
      });
      td.appendChild(preview);
    }

    td.addEventListener("click",(function(k){
      return function(){ handleDateClick(k); };
    })(key));

    tr.appendChild(td);
  }
  weekBody.appendChild(tr);
}

/* ====== Á®ÆÁõÆ„Éñ„É≠„ÉÉ„ÇØ„Éª„Çª„ÉÉ„Éà ====== */
function createExerciseBlock(data){
  var exName = data.exercise || "";
  var sets = (data.sets && data.sets.length) ? data.sets : [];

  var block = document.createElement("div");
  block.className = "exercise-block";

  var header = document.createElement("div");
  header.className = "exercise-header";

  var left = document.createElement("div");
  var title = document.createElement("span");
  title.className = "exercise-title";
  title.textContent = "Á®ÆÁõÆ";

  var badge = document.createElement("span");
  badge.className = "body-part-badge";
  badge.style.display = "none";

  left.appendChild(title);
  left.appendChild(badge);

  var remove = document.createElement("button");
  remove.className = "remove-exercise";
  remove.textContent = "ÂâäÈô§";
  remove.onclick = function(){
    block.remove();
    saveCurrentDay();
  };

  header.appendChild(left);
  header.appendChild(remove);
  block.appendChild(header);

  var sel = document.createElement("select");
  sel.innerHTML = '<option value="">Á®ÆÁõÆ„ÇíÈÅ∏Êäû</option>';
  exerciseCategories.forEach(function(cat){
    var og = document.createElement("optgroup");
    og.label = cat.label;
    cat.items.forEach(function(item){
      var opt = document.createElement("option");
      opt.value = item;
      opt.textContent = item;
      if (item === exName) opt.selected = true;
      og.appendChild(opt);
    });
    sel.appendChild(og);
  });

  sel.onchange = function(){
    var part = getBodyPart(sel.value);
    if (part){
      badge.style.display = "inline-block";
      badge.textContent = part;
      badge.style.background = getBodyPartColor(part);
    } else {
      badge.style.display = "none";
    }
    saveCurrentDay();
  };
  block.appendChild(sel);

  var setsContainer = document.createElement("div");
  block.appendChild(setsContainer);

  if (sets.length){
    sets.forEach(function(s){
      setsContainer.appendChild(createSetRow(setsContainer, s));
    });
  } else {
    setsContainer.appendChild(createSetRow(setsContainer, {weight:"", reps:""}));
  }

  var addSetBtn = document.createElement("button");
  addSetBtn.className = "add-set-btn";
  addSetBtn.textContent = "Ôºã „Çª„ÉÉ„ÉàËøΩÂä†";
  addSetBtn.onclick = function(){
    setsContainer.appendChild(createSetRow(setsContainer, {weight:"", reps:""}));
    saveCurrentDay();
  };
  block.appendChild(addSetBtn);

  var part0 = getBodyPart(exName);
  if (part0){
    badge.style.display = "inline-block";
    badge.textContent = part0;
    badge.style.background = getBodyPartColor(part0);
  }

  return block;
}

function createSetRow(container, data){
  var wVal = data.weight || "";
  var rVal = data.reps || "";

  var row = document.createElement("div");
  row.className = "set-row";

  var label = document.createElement("div");
  label.className = "set-label";
  label.textContent = "„Çª„ÉÉ„Éà " + (container.children.length + 1);
  row.appendChild(label);

  var fields = document.createElement("div");
  fields.className = "set-fields";

  var wInput = document.createElement("input");
  wInput.type = "number";
  wInput.placeholder = "ÈáçÈáè(kg)";
  wInput.value = wVal;
  wInput.oninput = saveCurrentDayDebounced;
  fields.appendChild(wInput);

  var rSelect = document.createElement("select");
  rSelect.innerHTML = '<option value="">ÂõûÊï∞</option>';
  for (var i=1; i<=20; i++){
    var opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = i + "Âõû";
    if (String(i) === String(rVal)) opt.selected = true;
    rSelect.appendChild(opt);
  }
  rSelect.onchange = saveCurrentDay;
  fields.appendChild(rSelect);

  row.appendChild(fields);

  var del = document.createElement("button");
  del.className = "delete-set-btn";
  del.textContent = "üóë";
  del.onclick = function(){
    row.remove();
    saveCurrentDay();
  };
  row.appendChild(del);

  return row;
}

/* ====== ‰øùÂ≠ò ====== */
var saveTimer = null;
function saveCurrentDay(){
  if (!selectedDateKey) return;

  var blocks = exerciseList.children;
  var exercises = [];

  for (var i=0; i<blocks.length; i++){
    var block = blocks[i];
    var sel = block.querySelector("select");
    var setRows = block.querySelectorAll(".set-row");
    var sets = [];
    for (var j=0; j<setRows.length; j++){
      var sRow = setRows[j];
      var inputs = sRow.querySelectorAll("input,select");
      var w = inputs[0].value;
      var r = inputs[1].value;
      if (w || r){
        sets.push({weight: w, reps: r});
      }
    }
    if (sel.value || sets.length){
      exercises.push({exercise: sel.value, sets: sets});
    }
  }

  events[selectedDateKey] = {
    exercises: exercises,
    note: note.value.trim()
  };

  localStorage.setItem("workout", JSON.stringify(events));
}

function saveCurrentDayDebounced(){
  clearTimeout(saveTimer);
  saveTimer = setTimeout(saveCurrentDay, 300);
}

/* ====== „É°„Éã„É•„ÉºÈñãÈñâ ====== */
function openMenu(){
  sideMenu.classList.add("open");
  menuOverlay.classList.add("open");
}
function closeMenu(){
  sideMenu.classList.remove("open");
  menuOverlay.classList.remove("open");
}
menuBtn.onclick = openMenu;
menuClose.onclick = closeMenu;
menuOverlay.onclick = closeMenu;

/* ====== Ë°®Á§∫Âàá„ÇäÊõø„Åà ====== */
menuMonth.onclick = function(){
  viewMode = "month";
  document.getElementById("month-view").style.display = "block";
  document.getElementById("week-view").style.display = "none";
  menuMonth.classList.add("active");
  menuWeek.classList.remove("active");
  closeMenu();
  renderMonth();
};
menuWeek.onclick = function(){
  viewMode = "week";
  document.getElementById("month-view").style.display = "none";
  document.getElementById("week-view").style.display = "block";
  menuWeek.classList.add("active");
  menuMonth.classList.remove("active");
  closeMenu();
  renderWeek();
};

/* ====== ÊúàÁßªÂãïÔºèÈÄ±ÁßªÂãï ====== */
document.getElementById("prev").onclick = function(){
  monthDate.setMonth(monthDate.getMonth()-1);
  renderMonth();
};
document.getElementById("next").onclick = function(){
  monthDate.setMonth(monthDate.getMonth()+1);
  renderMonth();
};

document.getElementById("week-prev").onclick = function(){
  weekDate.setDate(weekDate.getDate()-7);
  renderWeek();
};
document.getElementById("week-next").onclick = function(){
  weekDate.setDate(weekDate.getDate()+7);
  renderWeek();
};

/* ====== „Ç∑„Éº„Éà„ÅÆ„Çπ„ÉØ„Ç§„ÉóÔºà„Éè„É≥„Éâ„É´Ôºâ ====== */
var startY = 0;
var dragging = false;

sheetHandle.addEventListener("touchstart", function(e){
  if (e.touches.length !== 1) return;
  dragging = true;
  startY = e.touches[0].clientY;
});

sheetHandle.addEventListener("touchend", function(e){
  if (!dragging) return;
  dragging = false;
  var endY = e.changedTouches[0].clientY;
  var dy = endY - startY;
  var threshold = 40;

  if (dy > threshold && sheet.classList.contains("open")){
    closeSheet();
  } else if (dy < -threshold && sheet.classList.contains("closed")){
    sheet.classList.remove("closed");
    sheet.classList.add("open");
  }
});

/* ====== Êúà„Ç´„É¨„É≥„ÉÄ„Éº Ê®™„Çπ„ÉØ„Ç§„Éó ====== */
var swipeStartX = 0;
var swipeStartY = 0;
var isSwiping = false;

monthView.addEventListener("touchstart", function(e){
  if (e.touches.length !== 1) return;
  var t = e.touches[0];
  swipeStartX = t.clientX;
  swipeStartY = t.clientY;
  isSwiping = true;
  calendarTable.style.transition = "none";
});

monthView.addEventListener("touchmove", function(e){
  if (!isSwiping) return;
  var t = e.touches[0];
  var dx = t.clientX - swipeStartX;
  var dy = t.clientY - swipeStartY;

  if (Math.abs(dy) > Math.abs(dx)) return; // Á∏¶„ÅåÂ§ß„Åç„ÅÑ„Å®„Åç„ÅØÁÑ°Ë¶ñ

  calendarTable.style.transform = "translateX(" + dx + "px)";
});

monthView.addEventListener("touchend", function(e){
  if (!isSwiping) return;
  isSwiping = false;

  var t = e.changedTouches[0];
  var dx = t.clientX - swipeStartX;
  var dy = t.clientY - swipeStartY;

  calendarTable.style.transition = "transform 0.2s ease";

  var threshold = 60;

  if (Math.abs(dx) > threshold && Math.abs(dx) > Math.abs(dy)) {
    if (dx < 0) {
      // Â∑¶„Çπ„ÉØ„Ç§„Éó ‚Üí Ê¨°„ÅÆÊúà
      calendarTable.style.transform = "translateX(-100%)";
      setTimeout(function(){
        monthDate.setMonth(monthDate.getMonth() + 1);
        renderMonth();
        calendarTable.style.transition = "none";
        calendarTable.style.transform = "translateX(100%)";
        setTimeout(function(){
          calendarTable.style.transition = "transform 0.2s ease";
          calendarTable.style.transform = "translateX(0)";
        }, 0);
      }, 200);
    } else {
      // Âè≥„Çπ„ÉØ„Ç§„Éó ‚Üí Ââç„ÅÆÊúà
      calendarTable.style.transform = "translateX(100%)";
      setTimeout(function(){
        monthDate.setMonth(monthDate.getMonth() - 1);
        renderMonth();
        calendarTable.style.transition = "none";
        calendarTable.style.transform = "translateX(-100%)";
        setTimeout(function(){
          calendarTable.style.transition = "transform 0.2s ease";
          calendarTable.style.transform = "translateX(0)";
        }, 0);
      }, 200);
    }
  } else {
    calendarTable.style.transform = "translateX(0)";
  }
});

/* ====== „Åù„ÅÆ‰ªñ ====== */
document.getElementById("add-exercise").onclick = function(){
  exerciseList.appendChild(createExerciseBlock({exercise:"",sets:[]}));
  saveCurrentDay();
};

note.addEventListener("input", saveCurrentDayDebounced);

monthSelect.addEventListener("change", function(){
  var parts = monthSelect.value.split("-");
  var y = parseInt(parts[0],10);
  var m = parseInt(parts[1],10)-1;
  monthDate = new Date(y,m,1);
  renderMonth();
});

/* ====== ÂàùÊúüÊèèÁîª ====== */
initMonthSelect();
renderMonth();
renderWeek();
</script>
</body>
</html>
