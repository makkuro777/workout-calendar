<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Á≠ã„Éà„É¨„Ç´„É¨„É≥„ÉÄ„Éº</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <style>
    :root {
      --sheet-handle-visible: 28px;
      --sheet-closed-offset: calc(100% - var(--sheet-handle-visible));
      --drawer-width: 70vw;
    }

    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #f7f7f7;
      display: flex;
      justify-content: center;
      min-height: 100vh;
      overflow: hidden;
    }

    .container {
      width: 380px;
      max-width: 100%;
      margin-top: 88px;
      padding: 0 8px 80px;
      box-sizing: border-box;
      touch-action: pan-x;
    }

    .menu-button {
      position: fixed;
      top: 8px;
      left: 10px;
      width: 38px;
      height: 32px;
      border: none;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 5px;
      padding: 6px 8px;
      cursor: pointer;
      z-index: 1450;
    }

    .today-button {
      position: fixed;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 14px;
      border-radius: 14px;
      border: 1px solid #1976d2;
      background: #e3f2fd;
      color: #1976d2;
      font-weight: 700;
      font-size: 13px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      z-index: 1100;
    }

    .menu-line {
      height: 2px;
      background: #333;
      border-radius: 999px;
      width: 100%;
    }

    .drawer-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 1400;
    }

    .drawer-backdrop.show {
      opacity: 1;
      pointer-events: auto;
    }

    .drawer {
      position: fixed;
      top: 0;
      left: 0;
      width: var(--drawer-width);
      max-width: 320px;
      height: 100vh;
      background: #fff;
      box-shadow: 4px 0 14px rgba(0,0,0,0.18);
      transform: translateX(-100%);
      transition: transform 0.24s ease;
      z-index: 1420;
      display: flex;
      flex-direction: column;
      padding: 16px;
      box-sizing: border-box;
      gap: 12px;
    }

    .drawer.open {
      transform: translateX(0);
    }

    .drawer-title {
      font-size: 16px;
      font-weight: 700;
    }

    .drawer-option {
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
      background: #fafafa;
      font-size: 14px;
      text-align: left;
      cursor: pointer;
    }

    .drawer-option.active {
      background: #e3f2fd;
      border-color: #1976d2;
      color: #1976d2;
      font-weight: 700;
    }

    .dimmed {
      filter: brightness(0.7);
      pointer-events: none;
      user-select: none;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 6px;
    }

    .month-label {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      flex: 1;
    }

    .nav-btn {
      border: none;
      background: #e0e0e0;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      white-space: nowrap;
    }

    .month-select {
      font-size: 12px;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background-color: #fff;
    }

    .calendar-wrapper {
      overflow: hidden;
      width: 100%;
      touch-action: pan-x;
    }

    .week-view {
      display: none;
      background: #fff;
      border: 1px solid #eaeaea;
      border-radius: 10px;
      overflow: hidden;
    }

    .week-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      gap: 10px;
    }

    .week-row:last-child {
      border-bottom: none;
    }

    .week-row.selected {
      background: #fff9c4;
    }

    .week-date {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: 600;
    }

    .week-dayname {
      width: 24px;
      text-align: center;
    }

    .week-date-num {
      min-width: 42px;
      text-align: center;
      border-radius: 999px;
      padding: 4px 6px;
      box-sizing: border-box;
    }

    .week-date-num.today {
      background: #1976d2;
      color: #fff;
      font-weight: 700;
    }

    .week-preview {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 11px;
      justify-content: flex-end;
    }

    .week-list-animating {
      pointer-events: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      transition: transform 0.0s ease;
    }

    th {
      padding: 4px 0;
      font-size: 13px;
    }
    th:nth-child(1) { color: red; }
    th:nth-child(7) { color: blue; }

    td {
      height: 64px;
      border: 1px solid #eaeaea;
      padding: 4px;
      cursor: pointer;
      background: #fff;
      vertical-align: top;
      box-sizing: border-box;
    }
    td:hover {
      background: #f0f8ff;
    }
    .selected-day {
      background: #fff9c4 !important;
    }

    .day-number {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 12px;
    }
    .day-number.today {
      background-color: rgba(25, 118, 210, 0.16);
      border-radius: 50%;
    }

    .record-preview {
      font-size: 11px;
      margin-top: 4px;
      max-height: 32px;
      overflow: hidden;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .exercise-chip {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      color: #fff;
      white-space: nowrap;
    }

    .sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #fff;
      border-radius: 16px 16px 0 0;
      padding: 12px 16px 16px;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
      transition: transform 0.25s ease;
      box-sizing: border-box;
      max-height: 75vh;
      overflow-y: auto;
      transform: translateY(var(--sheet-closed-offset));
      touch-action: pan-y;
    }
    .sheet.open {
      transform: translateY(0);
    }

    .sheet-handle {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-bottom: 8px;
      touch-action: pan-y;
    }
    .sheet-handle-bar {
      width: 40px;
      height: 4px;
      border-radius: 999px;
      background: #ccc;
    }

    .sheet-title {
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .exercise-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .exercise-block {
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 8px;
      background: #fafafa;
    }

    .exercise-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 4px;
    }

    .exercise-title {
      font-size: 13px;
      font-weight: 600;
    }

    .body-part-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      color: #fff;
      margin-left: 4px;
    }

    .remove-exercise {
      font-size: 12px;
      border: none;
      background: transparent;
      color: #d32f2f;
      cursor: pointer;
    }

    .exercise-select-wrapper select {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
      background-color: #fff;
      box-sizing: border-box;
    }

    .sets-container {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .set-row {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 6px 32px 6px 6px; /* Âè≥‰∏äüóëÁî® */
      background: #fff;
      position: relative;
    }

    .set-label {
      font-size: 12px;
      margin-bottom: 3px;
      color: #555;
    }

    .set-fields {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .set-fields input,
    .set-fields select {
      font-size: 16px;
      padding: 4px;
      border-radius: 6px;
      border: 1px solid #ccc;
      flex: 1;
      box-sizing: border-box;
    }

    .delete-set-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      background: none;
      border: none;
      font-size: 16px;
      color: #d32f2f;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .add-set-btn {
      margin-top: 6px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px dashed #999;
      background: #fff;
      color: #555;
      font-size: 11px;
      cursor: pointer;
    }

    .add-exercise-btn {
      width: 100%;
      margin-top: 4px;
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 999px;
      border: 1px dashed #1976d2;
      background: #e3f2fd;
      color: #1976d2;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }

    .note-row {
      margin-top: 8px;
    }
    .note-row textarea {
      width: 100%;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
      resize: vertical;
    }
  </style>
</head>

<body>

<button id="menu-btn" class="menu-button" aria-label="„É°„Éã„É•„Éº">
  <span class="menu-line"></span>
  <span class="menu-line"></span>
  <span class="menu-line"></span>
</button>

<button id="today-btn" class="today-button" aria-label="‰ªäÊó•„Å´Êàª„Çã">‰ªäÊó•„Å´Êàª„Çã</button>

<div id="drawer-backdrop" class="drawer-backdrop"></div>
<div id="drawer" class="drawer" aria-label="Ë°®Á§∫ÂàáÊõø">
  <div class="drawer-title">Ë°®Á§∫„É¢„Éº„Éâ</div>
  <button id="mode-month" class="drawer-option">ÊúàË°®Á§∫</button>
  <button id="mode-week" class="drawer-option">ÈÄ±Ë°®Á§∫</button>
</div>

<div class="container" id="calendar-container">
  <div class="calendar-header">
    <button id="prev" class="nav-btn">Ôºú</button>
    <div class="month-label" id="month-label"></div>
    <select id="month-select" class="month-select"></select>
    <button id="next" class="nav-btn">Ôºû</button>
  </div>

  <div class="calendar-wrapper" id="calendar-wrapper">
    <table id="calendar-table">
      <thead>
        <tr>
          <th>Êó•</th><th>Êúà</th><th>ÁÅ´</th><th>Ê∞¥</th>
          <th>Êú®</th><th>Èáë</th><th>Âúü</th>
        </tr>
      </thead>
      <tbody id="calendar-body"></tbody>
    </table>
  </div>

  <div id="week-view" class="week-view" aria-hidden="true">
    <div id="week-list"></div>
  </div>
</div>

<div id="sheet" class="sheet">
  <div class="sheet-handle" id="sheet-handle">
    <div class="sheet-handle-bar"></div>
  </div>
  <div id="sheet-title" class="sheet-title"></div>

  <div id="exercise-list" class="exercise-list"></div>

  <button id="add-exercise" class="add-exercise-btn">Ôºã Á®ÆÁõÆ„ÇíËøΩÂä†</button>

  <div class="note-row">
    <textarea id="note" placeholder="„Åù„ÅÆ‰ªñ„É°„É¢Ôºà‰ªªÊÑèÔºâ"></textarea>
  </div>
</div>

<script>
/* ------------------------------------------------------
   Âü∫Êú¨„Éá„Éº„Çø
------------------------------------------------------ */
let current = new Date();
const events = JSON.parse(localStorage.getItem("workout") || "{}");
let currentWeekStart = startOfWeek(current);

const monthLabel = document.getElementById("month-label");
const monthSelect = document.getElementById("month-select");
const body = document.getElementById("calendar-body");
const sheet = document.getElementById("sheet");
const sheetHandle = document.getElementById("sheet-handle");
const note = document.getElementById("note");
const sheetTitle = document.getElementById("sheet-title");
const exerciseList = document.getElementById("exercise-list");
const addExerciseBtn = document.getElementById("add-exercise");
const calendarWrapper = document.getElementById("calendar-wrapper");
const calendarTable = document.getElementById("calendar-table");
const calendarContainer = document.getElementById("calendar-container");
const weekView = document.getElementById("week-view");
const weekList = document.getElementById("week-list");
const todayBtn = document.getElementById("today-btn");
const menuBtn = document.getElementById("menu-btn");
const drawer = document.getElementById("drawer");
const drawerBackdrop = document.getElementById("drawer-backdrop");
const modeMonthBtn = document.getElementById("mode-month");
const modeWeekBtn = document.getElementById("mode-week");

let viewMode = "month";
let isWeekAnimating = false;

let selectedDateKey = "";
let noteDebounceTimer = null;

const repsMax = 20;

/* ÈÉ®‰ΩçÔºÜËâ≤„Éû„ÉÉ„Éó */
const exerciseCategories = [
  { label: "ËÉ∏", color: "#e91e63", items: ["„Éô„É≥„ÉÅ„Éó„É¨„Çπ","„ÉÄ„É≥„Éô„É´„Éó„É¨„Çπ","„Ç§„É≥„ÇØ„É©„Ç§„É≥„Çπ„Éü„Çπ„Éó„É¨„Çπ","„Éö„ÉÉ„ÇØ„Éï„É©„Ç§"] },
  { label: "ËÉå‰∏≠", color: "#3f51b5", items: ["Êá∏ÂûÇ","„É©„ÉÉ„Éà„Éó„É´„ÉÄ„Ç¶„É≥","„Ç∑„Éº„ÉÜ„ÉÉ„Éâ„É≠„Éº","„Éá„ÉÉ„Éâ„É™„Éï„Éà","„Éï„Çß„Ç§„Çπ„Éó„É´"] },
  { label: "Ë∂≥", color: "#4caf50", items: ["„Çπ„ÇØ„ÉØ„ÉÉ„Éà","„É´„Éº„Éû„Éã„Ç¢„É≥„Éá„ÉÉ„Éâ„É™„Éï„Éà","„Éñ„É´„Ç¨„É™„Ç¢„É≥„Çπ„ÇØ„ÉØ„ÉÉ„Éà","„Éí„ÉÉ„Éó„Ç¢„ÉÄ„ÇØ„Ç∑„Éß„É≥"] },
  { label: "ËÇ©", color: "#ff9800", items: ["„Ç∑„Éß„É´„ÉÄ„Éº„Éó„É¨„Çπ","„É™„Ç¢„Éá„É´„Éà","„Çµ„Ç§„Éâ„É¨„Ç§„Ç∫"] },
  { label: "ËÖï", color: "#9c27b0", items: ["„Ç§„É≥„ÇØ„É©„Ç§„É≥„ÉÄ„É≥„Éô„É´„Ç´„Éº„É´","„Ç±„Éñ„É´„Éó„É¨„Çπ„ÉÄ„Ç¶„É≥","„Ç™„Éº„Éê„Éº„Éò„ÉÉ„Éâ„Ç®„ÇØ„Çπ„ÉÜ„É≥„Ç∑„Éß„É≥"] }
];

function startOfWeek(date) {
  const d = new Date(date);
  const diff = d.getDay();
  d.setHours(0,0,0,0);
  d.setDate(d.getDate() - diff);
  return d;
}

function isSameDay(a, b) {
  return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
}

function resetWeekAnimationState() {
  isWeekAnimating = false;
  weekList.classList.remove("week-list-animating");
  weekList.style.transition = "";
  weekList.style.transform = "";
  weekList.style.opacity = "";
}

function parseDateKey(key) {
  const [y, m, d] = key.split("-").map(n => parseInt(n, 10));
  return new Date(y, m - 1, d);
}

function dateKey(y, m, d) {
  return `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
}

function normalizeEvent(raw) {
  if (!raw) return { exercises: [], note: "" };
  if (typeof raw === "string") return { exercises: [], note: raw };

  const exs = (raw.exercises || []).map(e => ({
    exercise: e.exercise || "",
    sets: (e.sets || []).map(s => ({
      weight: s.weight || "",
      reps: s.reps || ""
    }))
  }));

  return { exercises: exs, note: raw.note || "" };
}

function getBodyPart(exName) {
  for (const cat of exerciseCategories) {
    if (cat.items.includes(exName)) return cat.label;
  }
  return null;
}
function getBodyPartColor(label) {
  const cat = exerciseCategories.find(c => c.label === label);
  return cat ? cat.color : "#999";
}

/* ------------------------------------------------------
   Âπ¥Êúà„Éó„É´„ÉÄ„Ç¶„É≥ÂàùÊúüÂåñ
------------------------------------------------------ */
(function initMonthSelect() {
  const baseYear = new Date().getFullYear();
  const startYear = baseYear - 5;
  the
... (truncated in this message for brevity)
