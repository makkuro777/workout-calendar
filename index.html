<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Á≠ã„Éà„É¨„Ç´„É¨„É≥„ÉÄ„Éº</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ÂÖ®‰Ωì„É¨„Ç§„Ç¢„Ç¶„Éà */
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #f7f7f7;
      display: flex;
      justify-content: center;
    }

    .container {
      width: 380px;
      max-width: 100%;
      margin-top: 20px;
      padding: 0 8px 80px;
      box-sizing: border-box;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .month-label {
      font-size: 20px;
      font-weight: bold;
    }

    .nav-btn {
      border: none;
      background: #e0e0e0;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
    }

    /* „Ç´„É¨„É≥„ÉÄ„Éº */
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    th {
      padding: 4px 0;
      font-size: 13px;
    }

    th:nth-child(1) { color: red; }
    th:nth-child(7) { color: blue; }
    th:nth-child(2),
    th:nth-child(3),
    th:nth-child(4),
    th:nth-child(5),
    th:nth-child(6) { color: #666; }

    td {
      height: 64px;
      border: 1px solid #eaeaea;
      padding: 4px;
      cursor: pointer;
      background: #fff;
      vertical-align: top;
      box-sizing: border-box;
    }

    td:hover {
      background: #f0f8ff;
    }

    .selected-day {
      background: #fff9c4 !important;
    }

    .day-number {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 12px;
    }

    .day-number.today {
      background-color: rgba(25, 118, 210, 0.16);
      border-radius: 50%;
    }

    .record-preview {
      font-size: 11px;
      color: #444;
      margin-top: 4px;
      max-height: 32px;
      overflow: hidden;
    }

    .sheet {
      position: fixed;
      bottom: -400px;
      left: 0;
      width: 100%;
      background: #fff;
      border-radius: 16px 16px 0 0;
      padding: 16px;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
      transition: bottom 0.3s ease;
      box-sizing: border-box;
      max-height: 75vh;
      overflow-y: auto;
    }

    .sheet.open {
      bottom: 0;
    }

    .sheet-title {
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .exercise-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .exercise-block {
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 8px;
      background: #fafafa;
    }

    .exercise-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .exercise-title {
      font-size: 13px;
      font-weight: 600;
    }

    .remove-exercise {
      font-size: 12px;
      border: none;
      background: transparent;
      color: #d32f2f;
      cursor: pointer;
    }

    .exercise-select-wrapper {
      margin-bottom: 6px;
    }

    .exercise-select-wrapper select {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 13px;
      background-color: #fff;
      box-sizing: border-box;
    }

    .sets-container {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .set-row {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 6px;
      background: #fff;
      position: relative;
    }

    .set-label {
      font-size: 12px;
      margin-bottom: 3px;
      color: #555;
    }

    .set-fields {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .set-fields select {
      font-size: 12px;
      padding: 4px;
      border-radius: 6px;
      border: 1px solid #ccc;
      flex: 1;
      box-sizing: border-box;
    }

    /* „Ç¥„ÉüÁÆ±„Éú„Çø„É≥ */
    .delete-set-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: #d32f2f;
      padding: 0;
      line-height: 1;
    }

    .add-set-btn {
      margin-top: 6px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px dashed #999;
      background: #fff;
      color: #555;
      font-size: 11px;
      cursor: pointer;
    }

    .add-exercise-btn {
      width: 100%;
      margin-top: 4px;
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 999px;
      border: 1px dashed #1976d2;
      background: #e3f2fd;
      color: #1976d2;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }

    .note-row {
      margin-top: 8px;
    }

    .note-row textarea {
      width: 100%;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 13px;
      resize: vertical;
      box-sizing: border-box;
    }
  </style>
</head>

<body>

<div class="container">
  <div class="calendar-header">
    <button class="nav-btn" id="prev">Ôºú</button>
    <div class="month-label" id="month-label"></div>
    <button class="nav-btn" id="next">Ôºû</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Êó•</th><th>Êúà</th><th>ÁÅ´</th><th>Ê∞¥</th>
        <th>Êú®</th><th>Èáë</th><th>Âúü</th>
      </tr>
    </thead>
    <tbody id="calendar-body"></tbody>
  </table>
</div>

<div id="sheet" class="sheet">
  <div class="sheet-title" id="sheet-title"></div>
  <div id="exercise-list" class="exercise-list"></div>

  <button id="add-exercise" class="add-exercise-btn">Ôºã Á®ÆÁõÆ„ÇíËøΩÂä†</button>

  <div class="note-row">
    <textarea id="note" rows="2" placeholder="„Åù„ÅÆ‰ªñ„É°„É¢Ôºà‰ªªÊÑèÔºâ"></textarea>
  </div>
</div>

<script>
  let current = new Date();
  const events = JSON.parse(localStorage.getItem("workout") || "{}");

  const monthLabel = document.getElementById("month-label");
  const body = document.getElementById("calendar-body");
  const sheet = document.getElementById("sheet");
  const note = document.getElementById("note");
  const sheetTitle = document.getElementById("sheet-title");
  const exerciseList = document.getElementById("exercise-list");
  const addExerciseBtn = document.getElementById("add-exercise");
  let selectedDateKey = "";

  let noteDebounceTimer = null;

  const repsMax = 20;

  /* --- Á®ÆÁõÆ„Ç´„ÉÜ„Ç¥„É™ --- */
  const exerciseCategories = [
    {
      label: "ËÉ∏",
      items: [
        "„Éô„É≥„ÉÅ„Éó„É¨„Çπ",
        "„ÉÄ„É≥„Éô„É´„Éó„É¨„Çπ",
        "„Ç§„É≥„ÇØ„É©„Ç§„É≥„Çπ„Éü„Çπ„Éó„É¨„Çπ",
        "„Éö„ÉÉ„ÇØ„Éï„É©„Ç§"
      ]
    },
    {
      label: "ËÉå‰∏≠",
      items: [
        "Êá∏ÂûÇ",
        "„É©„ÉÉ„Éà„Éó„É´„ÉÄ„Ç¶„É≥",
        "„Ç∑„Éº„ÉÜ„ÉÉ„Éâ„É≠„Éº",
        "„Éá„ÉÉ„Éâ„É™„Éï„Éà",
        "„Éï„Çß„Ç§„Çπ„Éó„É´"
      ]
    },
    {
      label: "Ë∂≥",
      items: [
        "„Çπ„ÇØ„ÉØ„ÉÉ„Éà",
        "„É´„Éº„Éû„Éã„Ç¢„É≥„Éá„ÉÉ„Éâ„É™„Éï„Éà",
        "„Éñ„É´„Ç¨„É™„Ç¢„É≥„Çπ„ÇØ„ÉØ„ÉÉ„Éà",
        "„Éí„ÉÉ„Éó„Ç¢„ÉÄ„ÇØ„Ç∑„Éß„É≥"
      ]
    },
    {
      label: "ËÇ©",
      items: [
        "„Ç∑„Éß„É´„ÉÄ„Éº„Éó„É¨„Çπ",
        "„É™„Ç¢„Éá„É´„Éà",
        "„Çµ„Ç§„Éâ„É¨„Ç§„Ç∫"
      ]
    },
    {
      label: "ËÖï",
      items: [
        "„Ç§„É≥„ÇØ„É©„Ç§„É≥„ÉÄ„É≥„Éô„É´„Ç´„Éº„É´",
        "„Ç±„Éº„Éñ„É´„Éó„É¨„Çπ„ÉÄ„Ç¶„É≥",
        "„Ç™„Éº„Éê„Éº„Éò„ÉÉ„Éâ„Ç®„ÇØ„Çπ„ÉÜ„É≥„Ç∑„Éß„É≥"
      ]
    }
  ];

  function dateKey(y, m, d) {
    return `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
  }

  /* --- „Éá„Éº„Çø‰∫íÊèõÂá¶ÁêÜ --- */
  function normalizeEvent(raw) {
    if (!raw) return { exercises: [], note: "" };

    if (typeof raw === "string") {
      return { exercises: [], note: raw };
    }

    if (Array.isArray(raw.exercises)) {
      const exs = raw.exercises.map(e => ({
        exercise: e.exercise || "",
        sets: Array.isArray(e.sets)
          ? e.sets.map(s => ({
              weight: s.weight || "",
              reps: s.reps || ""
            }))
          : []
      }));
      return { exercises: exs, note: raw.note || "" };
    }

    const exercise = raw.exercise || "";
    const sets = Array.isArray(raw.sets)
      ? raw.sets.map(s => ({
          weight: s.weight || "",
          reps: s.reps || ""
        }))
      : [];
    const noteText = raw.note || "";
    const exercises = (exercise || sets.length > 0)
      ? [{ exercise, sets }]
      : [];

    return { exercises, note: noteText };
  }

  /* --- „É¨„ÉÉ„ÉóÊï∞„Çª„É¨„ÇØ„ÉàÁîüÊàê --- */
  function fillRepsSelect(selectEl, selectedValue) {
    selectEl.innerHTML = "";
    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = "„É¨„ÉÉ„ÉóÊï∞";
    selectEl.appendChild(placeholder);

    for (let i = 1; i <= repsMax; i++) {
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = `${i}Âõû`;
      if (selectedValue && String(selectedValue) === String(i)) opt.selected = true;
      selectEl.appendChild(opt);
    }
  }

  /* --- ÈáçÈáè„Çª„É¨„ÇØ„ÉàÁîüÊàêÔºà2.5kgÂàª„ÅøÔºâ --- */
  function fillWeightSelect(selectEl, selectedValue) {
    selectEl.innerHTML = "";
    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = "ÈáçÈáè(kg)";
    selectEl.appendChild(placeholder);

    for (let i = 0; i <= 80; i++) { // 0„Äú200kg
      const w = i * 2.5;
      const label = Number.isInteger(w) ? w.toFixed(0) : w.toFixed(1);
      const opt = document.createElement("option");
      opt.value = label;
      opt.textContent = label;
      if (selectedValue && String(selectedValue) === String(label)) opt.selected = true;
      selectEl.appendChild(opt);
    }
  }

  /* --- Á®ÆÁõÆ„Çª„É¨„ÇØ„ÉàÔºà„Ç´„ÉÜ„Ç¥„É™‰ªò„ÅçÔºâ --- */
  function createExerciseSelect(selected) {
    const sel = document.createElement("select");
    sel.className = "exercise-select";

    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = "Á®ÆÁõÆ„ÇíÈÅ∏Êäû";
    sel.appendChild(placeholder);

    exerciseCategories.forEach(cat => {
      const optgroup = document.createElement("optgroup");
      optgroup.label = cat.label;

      cat.items.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        if (selected === name) opt.selected = true;
        optgroup.appendChild(opt);
      });

      sel.appendChild(optgroup);
    });

    return sel;
  }

  /* --- „Çª„ÉÉ„ÉàË°åÔºàüóë‰ªò„ÅçÔºâ --- */
  function createSetRow(setsContainer, setInfo) {
    const setRow = document.createElement("div");
    setRow.className = "set-row";

    const label = document.createElement("div");
    label.className = "set-label";
    label.textContent = "„Çª„ÉÉ„Éà";
    setRow.appendChild(label);

    const fields = document.createElement("div");
    fields.className = "set-fields";

    const weightSelect = document.createElement("select");
    weightSelect.className = "weight-select";
    fillWeightSelect(weightSelect, setInfo.weight);

    const repsSelect = document.createElement("select");
    repsSelect.className = "reps-select";
    fillRepsSelect(repsSelect, setInfo.reps);

    fields.appendChild(weightSelect);
    fields.appendChild(repsSelect);
    setRow.appendChild(fields);

    /* üóë ÂâäÈô§„Éú„Çø„É≥ */
    const delBtn = document.createElement("button");
    delBtn.className = "delete-set-btn";
    delBtn.innerHTML = "üóë";
    delBtn.addEventListener("click", () => {
      setRow.remove();
      renumberSets(setsContainer);
      saveCurrentDay();
    });
    setRow.appendChild(delBtn);

    return setRow;
  }

  /* --- „Çª„ÉÉ„ÉàÁï™Âè∑„ÅÆÂÜçÊåØ„ÇäÁõ¥„Åó --- */
  function renumberSets(container) {
    const rows = container.querySelectorAll(".set-row");
    rows.forEach((row, idx) => {
      row.querySelector(".set-label").textContent = `„Çª„ÉÉ„Éà ${idx + 1}`;
    });

    if (rows.length === 0) {
      const newRow = createSetRow(container, { weight: "", reps: "" });
      container.appendChild(newRow);
    }
  }

  /* --- Á®ÆÁõÆ„Éñ„É≠„ÉÉ„ÇØ‰ΩúÊàê --- */
  function createExerciseBlock(data) {
    const block = document.createElement("div");
    block.className = "exercise-block";

    const header = document.createElement("div");
    header.className = "exercise-header";

    const title = document.createElement("span");
    title.className = "exercise-title";
    title.textContent = "Á®ÆÁõÆ";

    const removeBtn = document.createElement("button");
    removeBtn.className = "remove-exercise";
    removeBtn.textContent = "ÂâäÈô§";
    removeBtn.addEventListener("click", () => {
      block.remove();
      saveCurrentDay();
    });

    header.appendChild(title);
    header.appendChild(removeBtn);
    block.appendChild(header);

    const selectWrap = document.createElement("div");
    selectWrap.className = "exercise-select-wrapper";
    const exerciseSelect = createExerciseSelect(data?.exercise);
    selectWrap.appendChild(exerciseSelect);
    block.appendChild(selectWrap);

    const setsContainer = document.createElement("div");
    setsContainer.className = "sets-container";
    block.appendChild(setsContainer);

    if (data?.sets?.length) {
      data.sets.forEach(s => {
        const row = createSetRow(setsContainer, s);
        setsContainer.appendChild(row);
      });
    } else {
      setsContainer.appendChild(createSetRow(setsContainer, { weight: "", reps: "" }));
    }

    const addSetBtn = document.createElement("button");
    addSetBtn.className = "add-set-btn";
    addSetBtn.textContent = "Ôºã „Çª„ÉÉ„ÉàËøΩÂä†";
    addSetBtn.addEventListener("click", () => {
      setsContainer.appendChild(createSetRow(setsContainer, { weight: "", reps: "" }));
      renumberSets(setsContainer);
      saveCurrentDay();
    });
    block.appendChild(addSetBtn);

    return block;
  }

  /* --- „Ç™„Éº„Éà„Çª„Éº„ÉñÔºàÁîªÈù¢ÂÜÖÂÆπ„ÇíË™≠„ÅøÂèñ„ÇãÔºâ --- */
  function saveCurrentDay() {
    if (!selectedDateKey) return;

    const blocks = Array.from(document.querySelectorAll(".exercise-block"));
    const exercises = [];

    blocks.forEach(block => {
      const exerciseSelect = block.querySelector(".exercise-select");
      const name = exerciseSelect.value;

      const setRows = block.querySelectorAll(".set-row");
      const sets = [];

      setRows.forEach(row => {
        const w = row.querySelector(".weight-select").value;
        const r = row.querySelector(".reps-select").value;
        if (w || r) sets.push({ weight: w, reps: r });
      });

      if (name || sets.length > 0) exercises.push({ exercise: name, sets });
    });

    const noteText = note.value.trim();

    if (exercises.length > 0 || noteText) {
      events[selectedDateKey] = { exercises, note: noteText };
    } else {
      delete events[selectedDateKey];
    }

    localStorage.setItem("workout", JSON.stringify(events));
    render();
  }

  function saveCurrentDayDebounced() {
    clearTimeout(noteDebounceTimer);
    noteDebounceTimer = setTimeout(() => saveCurrentDay(), 500);
  }

  /* --- Êó•‰ªò„ÅÆ„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ --- */
  function handleDateClick(key) {
    if (sheet.classList.contains("open")) {
      if (key === selectedDateKey) return;
      sheet.classList.remove("open");
      setTimeout(() => openSheet(key), 250);
    } else {
      openSheet(key);
    }
  }

  function openSheet(key) {
    selectedDateKey = key;
    render();

    const data = normalizeEvent(events[key]);
    sheetTitle.textContent = `${key} „ÅÆÁ≠ã„Éà„É¨`;

    exerciseList.innerHTML = "";
    if (data.exercises.length > 0) {
      data.exercises.forEach(ex => exerciseList.appendChild(createExerciseBlock(ex)));
    } else {
      exerciseList.appendChild(createExerciseBlock({}));
    }

    note.value = data.note || "";

    sheet.classList.add("open");
  }

  /* --- „Ç§„Éô„É≥„ÉàË®≠ÂÆö --- */
  addExerciseBtn.addEventListener("click", () => {
    exerciseList.appendChild(createExerciseBlock({}));
    saveCurrentDay();
  });

  sheet.addEventListener("change", e => {
    if (e.target.matches("select")) saveCurrentDay();
  });

  note.addEventListener("input", () => saveCurrentDayDebounced());

  /* --- „Ç´„É¨„É≥„ÉÄ„ÉºÊèèÁîª --- */
  function render() {
    const y = current.getFullYear();
    const m = current.getMonth();

    monthLabel.textContent = `${y}Âπ¥ ${m+1}Êúà`;
    body.innerHTML = "";

    const first = new Date(y, m, 1);
    const last = new Date(y, m + 1, 0);

    let row = document.createElement("tr");
    let count = 0;

    for (let i = 0; i < first.getDay(); i++) {
      row.appendChild(document.createElement("td"));
      count++;
    }

    const today = new Date();
    const isThisMonth =
      today.getFullYear() === y && today.getMonth() === m;

    for (let d = 1; d <= last.getDate(); d++) {
      if (count === 7) {
        body.appendChild(row);
        row = document.createElement("tr");
        count = 0;
      }

      const cell = document.createElement("td");

      const dayNumber = document.createElement("div");
      dayNumber.textContent = d;
      dayNumber.className = "day-number";

      const weekday = (first.getDay() + (d - 1)) % 7;
      if (weekday === 0) dayNumber.style.color = "red";
      if (weekday === 6) dayNumber.style.color = "blue";

      if (isThisMonth && today.getDate() === d) {
        dayNumber.classList.add("today");
      }

      cell.appendChild(dayNumber);

      const key = dateKey(y, m, d);

      if (key === selectedDateKey) cell.classList.add("selected-day");

      if (events[key]) {
        const preview = document.createElement("div");
        preview.className = "record-preview";
        preview.textContent = getPreviewText(events[key]);
        cell.appendChild(preview);
      }

      cell.addEventListener("click", () => handleDateClick(key));

      row.appendChild(cell);
      count++;
    }

    body.appendChild(row);
  }

  /* --- „Ç´„É¨„É≥„ÉÄ„Éº„Éó„É¨„Éì„É•„Éº --- */
  function getPreviewText(raw) {
    const data = normalizeEvent(raw);
    if (data.exercises.length > 0) {
      const e = data.exercises[0];
      const s = e.sets[0];
      if (e.exercise) return `${e.exercise} ${s?.weight || ""}kg ${s?.reps || ""}Âõû`;
    }
    if (data.note) return data.note.slice(0, 20);
    return "";
  }

  /* --- ÊúàÁßªÂãï --- */
  document.getElementById("prev").onclick = () => {
    current.setMonth(current.getMonth() - 1);
    render();
  };

  document.getElementById("next").onclick = () => {
    current.setMonth(current.getMonth() + 1);
    render();
  };

  render();
</script>

</body>
</html>
